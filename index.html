<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé™å€–å­˜è€…ï¼šå¾é›¶é–‹å§‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        canvas { background-color: #111827; display: block; border-radius: 0.5rem; cursor: crosshair; }
        .hud { position: absolute; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #xpBarContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 8px;
            background: #1e293b; z-index: 10;
        }
        #xpBar { width: 0%; height: 100%; background: #3b82f6; transition: width 0.2s; }
        .damage-flash { animation: flash 0.15s; }
        @keyframes flash { 0% { background: rgba(220, 38, 38, 0.5); } 100% { background: transparent; } }
    </style>
</head>
<body class="flex items-center justify-center h-screen m-0">

    <div id="xpBarContainer"><div id="xpBar"></div></div>

    <div class="relative">
        <canvas id="gameCanvas"></canvas>
        <div class="hud top-4 left-4 text-green-400 font-bold" id="hpUI">HP: 100 / 100</div>
        <div class="hud top-4 right-4 text-yellow-400 font-bold" id="scoreUI">SCORE: 0</div>
        <div class="hud top-12 left-1/2 -translate-x-1/2 text-slate-500 text-xs" id="levelUI">LEVEL 1</div>
    </div>

    <!-- åˆå§‹ä»‹é¢ -->
    <div id="startMenu" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-50">
        <h1 class="text-6xl font-black mb-2 text-blue-500">æ¥µé™ç”Ÿå­˜</h1>
        <p class="mb-8 text-slate-400">åˆå§‹åªæœ‰å–®ç™¼å­å½ˆï¼ŒåŠªåŠ›å‡ç´šå¼·åŒ–å½ˆé“ï¼</p>
        <button id="btnStart" class="bg-blue-600 hover:bg-blue-500 px-12 py-4 rounded-full text-2xl font-bold transition-all transform hover:scale-110">é–‹å§‹ä½œæˆ°</button>
    </div>

    <!-- å‡ç´šä»‹é¢ -->
    <div id="upgradeMenu" class="hidden absolute inset-0 bg-slate-950/90 flex flex-col items-center justify-center z-40">
        <h2 class="text-4xl font-black mb-8 text-blue-400">ç­‰ç´šæå‡ï¼é¸æ“‡å¼·åŒ–æ–¹å‘</h2>
        <div id="upgradeOptions" class="flex gap-6"></div>
    </div>

    <!-- çµæŸä»‹é¢ -->
    <div id="deathMenu" class="hidden absolute inset-0 bg-red-950/90 flex flex-col items-center justify-center z-50">
        <h1 class="text-6xl font-black mb-4 text-white">ä½ é™£äº¡äº†</h1>
        <p id="finalScore" class="text-2xl mb-8 text-red-200">å¾—åˆ†: 0</p>
        <button onclick="location.reload()" class="bg-white text-red-900 px-10 py-3 rounded-full font-bold">é‡æ–°å•Ÿå‹•</button>
    </div>

    <script>
        // éŸ³æ•ˆæ§åˆ¶
        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, t, d, v=0.05) {
            try {
                const o = audio.createOscillator();
                const g = audio.createGain();
                o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
                g.gain.setValueAtTime(v, audio.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + d);
                o.connect(g); g.connect(audio.destination);
                o.start(); o.stop(audio.currentTime + d);
            } catch(e) {}
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let w, h, player, gameActive = false;
        let enemies = [], bullets = [], orbs = [], items = [];
        let frame = 0, score = 0;
        let shootTimer = 0;

        // å‡ç´šå®šç¾©
        const UPGRADES = {
            bullets: { name: "å¤šé‡å½ˆé“", desc: "å¢åŠ é¡å¤– 1 æ¢ç™¼å°„è·¯å¾‘", icon: "ğŸ¹", level: 1, max: 8 },
            fireRate: { name: "æ€¥é€Ÿå°„æ“Š", desc: "æå‡ 20% æ”»æ“Šé€Ÿåº¦", icon: "âš¡", level: 0, max: 10 },
            damage: { name: "å¼·åŒ–å½ˆé ­", desc: "å­å½ˆå‚·å®³ +5", icon: "ğŸ’¥", level: 0, max: 10 },
            speed: { name: "å‹•åŠ›è£ç”²", desc: "ç§»å‹•é€Ÿåº¦å¢åŠ ", icon: "ğŸ‘Ÿ", level: 0, max: 5 },
            magnet: { name: "ç£åŠ›å¢å¼·", desc: "æ“´å¤§æ‹¾å–ç¶“é©—ç¯„åœ", icon: "ğŸ§²", level: 0, max: 5 }
        };

        function initCanvas() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', initCanvas);
        initCanvas();

        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        class Player {
            constructor() {
                this.x = w/2; this.y = h/2;
                this.r = 15; this.hp = 100; this.maxHp = 100;
                this.xp = 0; this.lv = 1; this.nextXp = 50;
                this.speed = 4; this.pickupR = 80;
                this.damage = 10; this.fireRate = 40; // è¶Šå°è¶Šå¿«
                this.bulletCount = 1;
            }
            update() {
                if (keys['KeyW'] || keys['ArrowUp']) this.y -= this.speed;
                if (keys['KeyS'] || keys['ArrowDown']) this.y += this.speed;
                if (keys['KeyA'] || keys['ArrowLeft']) this.x -= this.speed;
                if (keys['KeyD'] || keys['ArrowRight']) this.x += this.speed;
                this.x = Math.max(this.r, Math.min(w - this.r, this.x));
                this.y = Math.max(this.r, Math.min(h - this.r, this.y));

                // è‡ªå‹•å°„æ“Š
                shootTimer++;
                if (shootTimer >= this.fireRate) {
                    this.shoot();
                    shootTimer = 0;
                }
            }
            shoot() {
                let target = null;
                let minDist = Infinity;
                enemies.forEach(e => {
                    const d = Math.hypot(e.x - this.x, e.y - this.y);
                    if (d < minDist) { minDist = d; target = e; }
                });

                if (target) {
                    const angle = Math.atan2(target.y - this.y, target.x - this.x);
                    const spread = 0.2; // å½ˆé“é–“è·
                    for (let i = 0; i < this.bulletCount; i++) {
                        const offset = (i - (this.bulletCount - 1) / 2) * spread;
                        bullets.push(new Bullet(this.x, this.y, angle + offset, this.damage));
                    }
                    playSfx(400, 'square', 0.1, 0.03);
                }
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                ctx.fillStyle = '#3b82f6';
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        class Bullet {
            constructor(x, y, angle, dmg) {
                this.x = x; this.y = y; this.dmg = dmg;
                this.vx = Math.cos(angle) * 10;
                this.vy = Math.sin(angle) * 10;
                this.r = 4;
            }
            update() { this.x += this.vx; this.y += this.vy; }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                ctx.fillStyle = '#60a5fa';
                ctx.fill();
            }
        }

        class Enemy {
            constructor() {
                const side = Math.floor(Math.random() * 4);
                if (side === 0) { this.x = Math.random() * w; this.y = -20; }
                else if (side === 1) { this.x = w + 20; this.y = Math.random() * h; }
                else if (side === 2) { this.x = Math.random() * w; this.y = h + 20; }
                else { this.x = -20; this.y = Math.random() * h; }
                this.r = 12 + Math.random() * 8;
                this.hp = 10 + player.lv * 5;
                this.speed = 1.5 + Math.random() * 1;
            }
            update() {
                const angle = Math.atan2(player.y - this.y, player.x - this.x);
                this.x += Math.cos(angle) * this.speed;
                this.y += Math.sin(angle) * this.speed;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                ctx.fillStyle = '#ef4444';
                ctx.fill();
            }
        }

        class Orb {
            constructor(x, y) { this.x = x; this.y = y; this.r = 4; this.val = 10; }
            update() {
                const d = Math.hypot(player.x - this.x, player.y - this.y);
                if (d < player.pickupR) {
                    const angle = Math.atan2(player.y - this.y, player.x - this.x);
                    this.x += Math.cos(angle) * 8;
                    this.y += Math.sin(angle) * 8;
                }
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
                ctx.fillStyle = '#fbbf24';
                ctx.fill();
            }
        }

        class Heal {
            constructor(x, y) { this.x = x; this.y = y; this.r = 10; }
            draw() {
                ctx.fillStyle = '#22c55e';
                ctx.fillRect(this.x-10, this.y-10, 20, 20);
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x-2, this.y-7, 4, 14);
                ctx.fillRect(this.x-7, this.y-2, 14, 4);
            }
        }

        function showUpgrade() {
            gameActive = false;
            document.getElementById('upgradeMenu').classList.remove('hidden');
            const options = document.getElementById('upgradeOptions');
            options.innerHTML = '';
            
            const pool = Object.keys(UPGRADES).filter(k => UPGRADES[k].level < UPGRADES[k].max);
            const picks = pool.sort(() => 0.5 - Math.random()).slice(0, 3);

            picks.forEach(key => {
                const up = UPGRADES[key];
                const card = document.createElement('div');
                card.className = "bg-slate-800 p-6 rounded-xl border-2 border-slate-700 hover:border-blue-500 cursor-pointer w-48 text-center transition-all hover:scale-105";
                card.innerHTML = `
                    <div class="text-4xl mb-4">${up.icon}</div>
                    <div class="font-bold text-xl mb-2">${up.name}</div>
                    <div class="text-xs text-slate-400">${up.desc}</div>
                    <div class="mt-4 text-blue-400 font-mono">LV ${up.level}</div>
                `;
                card.onclick = () => {
                    applyUpgrade(key);
                    document.getElementById('upgradeMenu').classList.add('hidden');
                    gameActive = true;
                    loop();
                };
                options.appendChild(card);
            });
        }

        function applyUpgrade(key) {
            UPGRADES[key].level++;
            playSfx(600, 'triangle', 0.2);
            if (key === 'bullets') player.bulletCount++;
            if (key === 'fireRate') player.fireRate = Math.max(10, player.fireRate * 0.8);
            if (key === 'damage') player.damage += 5;
            if (key === 'speed') player.speed += 0.8;
            if (key === 'magnet') player.pickupR += 50;
        }

        function loop() {
            if (!gameActive) return;
            ctx.clearRect(0, 0, w, h);
            frame++;

            player.update();
            player.draw();

            // ç”Ÿæˆæ•µäººç¾¤
            if (frame % Math.max(20, 60 - player.lv * 2) === 0) enemies.push(new Enemy());

            // æ›´æ–°å­å½ˆ
            bullets.forEach((b, bi) => {
                b.update(); b.draw();
                if (b.x<0 || b.x>w || b.y<0 || b.y>h) bullets.splice(bi, 1);
            });

            // æ›´æ–°æ•µäºº
            enemies.forEach((e, ei) => {
                e.update(); e.draw();
                // æ’æ“Šç©å®¶
                if (Math.hypot(player.x - e.x, player.y - e.y) < player.r + e.r) {
                    player.hp -= 0.5;
                    document.body.classList.add('damage-flash');
                    setTimeout(() => document.body.classList.remove('damage-flash'), 50);
                    if (player.hp <= 0) {
                        gameActive = false;
                        document.getElementById('deathMenu').classList.remove('hidden');
                        document.getElementById('finalScore').textContent = `å¾—åˆ†: ${score}`;
                    }
                }
                // è¢«å­å½ˆæ“Šä¸­
                bullets.forEach((b, bi) => {
                    if (Math.hypot(e.x - b.x, e.y - b.y) < e.r + b.r) {
                        e.hp -= b.dmg;
                        bullets.splice(bi, 1);
                        playSfx(200, 'sine', 0.05, 0.02);
                        if (e.hp <= 0) {
                            score += 10;
                            orbs.push(new Orb(e.x, e.y));
                            if (Math.random() < 0.05) items.push(new Heal(e.x, e.y));
                            enemies.splice(ei, 1);
                        }
                    }
                });
            });

            // æ›´æ–°ç¶“é©—å€¼
            orbs.forEach((o, oi) => {
                o.update(); o.draw();
                if (Math.hypot(player.x - o.x, player.y - o.y) < player.r + o.r) {
                    player.xp += o.val;
                    orbs.splice(oi, 1);
                    playSfx(800, 'sine', 0.05, 0.01);
                    if (player.xp >= player.nextXp) {
                        player.lv++;
                        player.xp = 0;
                        player.nextXp = Math.floor(player.nextXp * 1.3);
                        showUpgrade();
                    }
                }
            });

            // æ›´æ–°é“å…·
            items.forEach((it, iti) => {
                it.draw();
                if (Math.hypot(player.x - it.x, player.y - it.y) < player.r + it.r) {
                    player.hp = Math.min(player.maxHp, player.hp + 25);
                    items.splice(iti, 1);
                    playSfx(500, 'sine', 0.3, 0.1);
                }
            });

            // UI æ›´æ–°
            document.getElementById('hpUI').textContent = `HP: ${Math.ceil(player.hp)} / ${player.maxHp}`;
            document.getElementById('scoreUI').textContent = `SCORE: ${score}`;
            document.getElementById('levelUI').textContent = `LEVEL ${player.lv}`;
            document.getElementById('xpBar').style.width = (player.xp / player.nextXp * 100) + '%';

            requestAnimationFrame(loop);
        }

        document.getElementById('btnStart').onclick = () => {
            if (audio.state === 'suspended') audio.resume();
            document.getElementById('startMenu').classList.add('hidden');
            player = new Player();
            gameActive = true;
            loop();
        };

    </script>
</body>
</html>