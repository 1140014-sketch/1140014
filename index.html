<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé™å€–å­˜è€…ï¼šæ–°å¹´è±ªè¯é€²åŒ–ç‰ˆ v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; margin: 0; }
        canvas { display: block; cursor: crosshair; }
        .hud { position: absolute; pointer-events: none; z-index: 20; }
        
        #xpBarContainer { position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #1e293b; z-index: 10; }
        #xpBar { width: 0%; height: 100%; background: linear-gradient(90deg, #3b82f6, #a855f7); box-shadow: 0 0 15px #3b82f6; transition: width 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        .damage-flash { animation: flash 0.15s; }
        @keyframes flash { 0% { filter: brightness(3) contrast(1.2) hue-rotate(-20deg); } 100% { filter: none; } }
        
        .boss-warning { 
            position: absolute; top: 35%; left: 0; width: 100%; text-align: center;
            font-size: 5rem; font-weight: 900; color: #ef4444; z-index: 100;
            text-transform: uppercase; letter-spacing: 1rem;
            animation: boss-alert 0.6s infinite alternate; display: none;
            text-shadow: 0 0 30px #ef4444;
        }
        @keyframes boss-alert { 0% { opacity: 0.3; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1.1); } }
        
        #bossHpContainer { 
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 60%; height: 20px; 
            background: #450a0a; border: 3px solid #ef4444; border-radius: 12px; 
            display: none; z-index: 20; overflow: hidden; box-shadow: 0 0 30px rgba(239, 68, 68, 0.6);
        }
        #bossHpBar { width: 100%; height: 100%; background: linear-gradient(90deg, #b91c1c, #ef4444, #f87171); transition: width 0.15s; }
        
        .modal { backdrop-filter: blur(20px); background: rgba(7, 10, 25, 0.85); }
        .interactive { pointer-events: auto; }

        /* AI å½ˆçª—å¼·åŒ– */
        #aiBrief {
            position: absolute; bottom: 30px; left: 30px; width: 320px;
            background: rgba(15, 23, 42, 0.95); border-left: 5px solid #06b6d4;
            padding: 16px; border-radius: 4px 12px 12px 4px; font-size: 14px;
            transform: translateX(-130%); transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #aiBrief.active { transform: translateX(0); }
        .ai-glitch { animation: glitch 0.3s infinite; }
        @keyframes glitch { 
            0% { transform: translate(0); } 
            20% { transform: translate(-2px, 1px); } 
            40% { transform: translate(2px, -1px); } 
            100% { transform: translate(0); } 
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen m-0 select-none">

    <div id="xpBarContainer"><div id="xpBar"></div></div>
    <div id="bossHpContainer"><div id="bossHpBar"></div></div>
    <div id="bossWarning" class="boss-warning font-black">åµæ¸¬åˆ°é«˜èƒ½ç›®æ¨™</div>
<!-- æ­£å¼ç‰ˆç™¼å¸ƒå…¬å‘Š (New) -->
    <div id="announcementModal" class="absolute inset-0 flex flex-col items-center justify-center z-[100] modal">
        <div class="bg-red-900 border-4 border-yellow-500 p-8 rounded-3xl max-w-md w-11/12 text-center shadow-[0_0_50px_rgba(234,179,8,0.3)]">
            <div class="text-6xl mb-4">ğŸ“¢</div>
            <h2 class="text-3xl font-black text-yellow-500 mb-4 italic">æ­£å¼ç‰ˆå·²ç™¼å¸ƒï¼</h2>
            <div class="space-y-4 text-red-100 mb-8 leading-relaxed">
                <p class="text-lg">è¦ªæ„›çš„å€–å­˜è€…ï¼š</p>
                <p>æœ¬ä½œçš„æ­£å¼å®Œæ•´ç‰ˆæœ¬å·²ç¶“æ­£å¼ä¸Šç·šï¼</p>
                <p class="bg-red-950/50 p-3 rounded-xl border border-red-700 font-bold text-yellow-200">
                    æ­¤ã€Œæ–°å¹´æ¸¬è©¦ç‰ˆã€å³æ—¥èµ·å°‡åœæ­¢å…§å®¹æ›´æ–°ã€‚
                </p>
                <p class="text-sm opacity-80">æ„Ÿè¬æ‚¨åœ¨æ¸¬è©¦æœŸé–“çš„æ”¯æŒèˆ‡é™ªä¼´ï¼Œç¥æ‚¨æ–°å¹´å¿«æ¨‚ï¼Œè¬äº‹å¦‚æ„ï¼</p>
            </div>
            <button onclick="closeAnnouncement()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-red-950 font-black py-4 rounded-2xl text-xl transition-all active:scale-95">
                æˆ‘çŸ¥é“äº† (é€²å…¥éŠæˆ²)
            </button>
        </div>
    </div>
    <!-- æˆ°è¡“ AI å½ˆçª— -->
    <div id="aiBrief">
        <div class="text-cyan-400 font-bold mb-1 flex items-center justify-between">
            <span class="flex items-center gap-2"><span class="w-2 h-2 bg-cyan-400 rounded-full animate-ping"></span> TACTICAL AI v3.0</span>
            <span class="text-[10px] opacity-50">ENCRYPTED</span>
        </div>
        <div id="aiBriefContent" class="text-slate-300 leading-relaxed italic">åˆå§‹åŒ–æˆ°è¡“éˆæ¥...</div>
    </div>

    <div class="relative w-full h-full">
        <canvas id="gameCanvas"></canvas>
        
        <!-- HUD è³‡è¨Š -->
        <div class="hud top-8 left-8">
            <div id="hpUI" class="text-white font-black text-3xl tracking-tighter italic">HP: 100 / 100</div>
            <div class="w-56 h-3 bg-slate-900 rounded-full mt-2 border border-slate-700 p-0.5">
                <div id="hpInnerBar" class="h-full bg-gradient-to-r from-red-600 to-rose-400 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(225,29,72,0.5)]" style="width: 100%"></div>
            </div>
        </div>
        
        <div class="hud top-8 right-8 text-right">
            <div id="scoreUI" class="text-white font-black text-4xl italic tracking-tighter">000000</div>
            <div id="coinUI" class="text-yellow-400 font-bold text-2xl flex items-center justify-end gap-1 mt-1">
                <span class="text-xs opacity-70">CREDITS</span> <span id="coinVal">0</span>
            </div>
        </div>

        <div class="hud top-28 left-8">
            <button id="btnAIAnalysis" onclick="openAIAnalysis()" class="bg-cyan-500/10 hover:bg-cyan-500/20 text-cyan-400 px-5 py-2.5 rounded-full border border-cyan-400/50 transition-all text-xs font-black interactive flex items-center gap-2 uppercase tracking-widest backdrop-blur-md">
                <span class="text-lg">ğŸ¤–</span> åˆ†æç•¶å‰æˆ°å±€
            </button>
        </div>
    </div>

    <!-- ä¸»é¸å–® -->
    <div id="startMenu" class="absolute inset-0 flex flex-col items-center justify-center z-50 p-4 modal">
        <div class="text-center mb-16">
            <div class="bg-blue-600 text-white px-4 py-1 rounded-full text-xs font-bold mb-4 tracking-[0.3em] inline-block">MAJOR UPDATE v3.0</div>
            <h1 class="text-[10rem] font-black text-white tracking-tighter italic uppercase leading-none drop-shadow-[0_0_50px_rgba(59,130,246,0.6)]">Survivor</h1>
            <h2 class="text-4xl font-bold text-yellow-500 tracking-[0.5em] mt-2 italic">æ¥µé™å€–å­˜è€…ï¼šé€²åŒ–</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-10 w-full max-w-5xl mb-12">
            <div class="bg-slate-900/60 p-10 rounded-[2rem] border border-slate-700/50 shadow-2xl backdrop-blur-xl">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-slate-400 font-bold tracking-widest">æœ€é«˜ä½œæˆ°è¨˜éŒ„</span>
                    <span id="menuHighScore" class="text-white font-black text-4xl font-mono">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400 font-bold tracking-widest">ç´¯ç©è»è³‡</span>
                    <span id="menuCoins" class="text-yellow-400 font-black text-4xl font-mono">0</span>
                </div>
            </div>
            
            <div class="flex flex-col gap-5">
                <button onclick="startGame(false)" class="w-full bg-blue-600 hover:bg-blue-500 py-8 rounded-3xl text-3xl font-black text-white transition-all transform hover:scale-105 shadow-[0_20px_50px_rgba(59,130,246,0.4)] group">
                    <span class="group-hover:tracking-widest transition-all">é€²å…¥æˆ°å€ (Endless)</span>
                </button>
                <button id="btnNewYear" onclick="startGame(true)" class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 py-5 rounded-3xl text-xl font-bold text-white transition-all border-2 border-yellow-400 shadow-[0_10px_30px_rgba(220,38,38,0.4)]">
                    ğŸ§¨ æ–°å¹´ç‰¹æ”»ï¼šè¯ä»”æŒ‘æˆ°
                </button>
            </div>
        </div>
    </div>

    <!-- å•†åº—èˆ‡å‡ç´š (ç•¥ï¼Œçµæ§‹åŒå‰ï¼Œä½†ç¾åŒ–æ¨£å¼) -->
    <div id="shopModal" class="hidden absolute inset-0 flex flex-col items-center justify-center z-[60] p-6 modal">
        <div class="w-full max-w-5xl h-[85vh] bg-slate-900/95 rounded-[3rem] border border-slate-700 flex flex-col shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between p-10 border-b border-slate-800">
                <h2 class="text-4xl font-black text-white italic tracking-tighter">ARMORY <span class="text-blue-500">è»éœ€åº«</span></h2>
                <div class="flex items-center gap-8">
                    <div class="text-yellow-500 font-bold text-2xl font-mono">$<span id="shopCoins">0</span></div>
                    <button onclick="closeShop()" class="text-slate-400 hover:text-white text-4xl">âœ•</button>
                </div>
            </div>
            <div class="flex-1 p-10 overflow-y-auto" id="charList"></div>
        </div>
    </div>

    <div id="upgradeMenu" class="hidden absolute inset-0 flex flex-col items-center justify-center z-40 modal">
        <div class="text-center mb-16">
            <h2 class="text-6xl font-black text-white italic tracking-tighter">EVOLUTION SELECT</h2>
            <p class="text-cyan-400 font-bold tracking-[0.5em] mt-2">è«‹é¸æ“‡æˆ°è¡“å‡ç´šè·¯å¾‘</p>
        </div>
        <div id="upgradeOptions" class="flex flex-wrap justify-center gap-10"></div>
    </div>

    <div id="deathMenu" class="hidden absolute inset-0 flex flex-col items-center justify-center z-50 modal bg-red-950/95">
        <h1 class="text-9xl font-black mb-6 text-white italic tracking-tighter uppercase">Mission Failed</h1>
        <p id="finalScore" class="text-5xl mb-3 text-red-200 font-mono">SCORE: 0</p>
        <p class="text-yellow-400 text-3xl mb-16 font-bold italic tracking-widest">+ $<span id="earnedCoins">0</span> CREDITS EARNED</p>
        <div class="flex gap-8">
            <button onclick="location.reload()" class="bg-white text-red-950 px-16 py-6 rounded-3xl text-3xl font-black shadow-2xl hover:bg-slate-200 transition-all transform hover:scale-110">é‡å•Ÿæˆ°å€</button>
            <button onclick="returnToMenu()" class="bg-slate-800 text-white px-16 py-6 rounded-3xl text-3xl font-bold hover:bg-slate-700 transition-all">è¿”å›ç¸½éƒ¨</button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const SAVE_KEY = 'survivor_v3_data';
        
        let userData = {
            highScore: 0,
            coins: 0,
            inventory: ['soldier'],
            selectedChar: 'soldier'
        };

        const CHARACTERS = {
            soldier: { name: "æ¨™æº–ç‰¹ç¨®å…µ", desc: "å‡è¡¡å‹è§’è‰²ï¼Œé©åˆåˆæ­¥æ¢ç´¢å€åŸŸã€‚", cost: 0, color: '#3b82f6', hpMod: 1, spdMod: 1, dmgMod: 1 },
            tank: { name: "é‡è£æ©Ÿå…µ", desc: "çŠ§ç‰²æ©Ÿå‹•åŠ›æ›å–æ¥µé«˜ç”Ÿå­˜èƒ½åŠ›ã€‚", cost: 2000, color: '#10b981', hpMod: 2.0, spdMod: 0.65, dmgMod: 1.2 },
            ghost: { name: "å¹½éˆç‰¹å·¥", desc: "é…å‚™è©¦é©—å‹æ¨é€²å™¨èˆ‡é«˜é€±æ³¢å½ˆè—¥ã€‚", cost: 4500, color: '#8b5cf6', hpMod: 0.8, spdMod: 1.5, dmgMod: 1.5 },
            andylau: { name: "åŠ‰å¾·è¯", desc: "ã€æ–°å¹´é™å®šã€‘å¤©ç‹æ°£å ´åŠ æŒï¼Œæ•¸å€¼å…¨é¢çªç ´ã€‚", cost: 0, color: '#ef4444', hpMod: 1.5, spdMod: 1.2, dmgMod: 1.8, isHidden: true }
        };

        const UPGRADES = {
            bullets: { name: "ç«åŠ›ç¶²æ“´å¼µ", desc: "åŒæ­¥ç™¼å°„æ›´å¤šå½ˆè—¥", icon: "ğŸš€", level: 0, max: 5 },
            fireRate: { name: "å°„æ§å„ªåŒ–", desc: "é™ä½å°„æ“Šå†·å»æ™‚é–“", icon: "ğŸ”¥", level: 0, max: 5 },
            damage: { name: "é«˜èƒ½å½ˆé ­", desc: "å¼·åŒ–å­å½ˆè¦–è¦ºèˆ‡å¨åŠ›", icon: "ğŸ’£", level: 0, max: 5 },
            speed: { name: "æ¨é€²å¼·åŒ–", desc: "æå‡æˆ°è¡“ç§»å‹•é€Ÿåº¦", icon: "ğŸƒ", level: 0, max: 5 },
            regen: { name: "ä¿®å¾©ç´ç±³", desc: "è‡ªå‹•ä¿®å¾©å—æè£ç”²", icon: "â¤ï¸", level: 0, max: 5 }
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let player, gameActive = false, gamePaused = false, frame = 0, score = 0, sessionCoins = 0;
        let enemies = [], bullets = [], orbs = [], particles = [], activeBoss = null;
        let isNewYearMode = false;

        const camera = {
            x: 0, y: 0, shake: 0,
            update(tx, ty) {
                this.x += (tx - (canvas.width/2) - this.x) * 0.1;
                this.y += (ty - (canvas.height/2) - this.y) * 0.1;
                if (this.shake > 0) {
                    this.x += (Math.random() - 0.5) * this.shake;
                    this.y += (Math.random() - 0.5) * this.shake;
                    this.shake *= 0.88;
                }
            },
            toScreen(wx, wy) { return { x: wx - this.x, y: wy - this.y }; }
        };

        async function openAIAnalysis() {
            if (!gameActive) return;
            const content = document.getElementById('aiBriefContent');
            const brief = document.getElementById('aiBrief');
            content.innerText = "æˆ°å ´æƒæä¸­...";
            brief.classList.add('active');
            brief.classList.add('ai-glitch');

            const prompt = `ä½ æ˜¯ä¸€å€‹å†·é…·çš„é«˜ç§‘æŠ€æˆ°é¬¥åŠ©æ‰‹ã€‚æ ¹æ“šä»¥ä¸‹æ•¸æ“šçµ¦ä¸€å¥ä¸è¶…é20å­—çš„ä¸­æ–‡ç¹é«”æˆ°è¡“å»ºè­°ï¼šç­‰ç´š${player.lv}, HP${Math.round(player.hp)}, å¨è„…ç­‰ç´š${enemies.length > 20 ? 'æ¥µé«˜' : 'ä¸­ç­‰'}, æ˜¯å¦æœ‰Boss:${!!activeBoss}`;

            try {
                if(!apiKey) throw new Error();
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await resp.json();
                content.innerText = data.candidates[0].content.parts[0].text;
            } catch(e) {
                content.innerText = activeBoss ? "åµæ¸¬åˆ°é ˜è¢–ç´šå–®ä½ï¼Œå„ªå…ˆé›†ç«ç›®æ¨™æ ¸å¿ƒã€‚" : "ç•¶å‰æ³¢æ¬¡ç©©å®šï¼Œå»ºè­°æ”¶é›†æ™¶é«”ä»¥é€²åŒ–æ­¦å™¨ç³»çµ±ã€‚";
            }
            setTimeout(() => { brief.classList.remove('active'); brief.classList.remove('ai-glitch'); }, 8000);
        }

        async function triggerAISuggestion(type) {
            const brief = document.getElementById('aiBrief');
            const content = document.getElementById('aiBriefContent');
            brief.classList.add('active');
            
            let text = "";
            if (type === 'boss') text = "è­¦å‘Šï¼šåµæ¸¬åˆ°ä¸æ˜é«˜èƒ½åæ‡‰ï¼Œæˆ°è¡“èª¿æ•´ç‚ºå„ªå…ˆè¦é¿ã€‚";
            else if (type === 'level') text = "å‡ç´šå®Œç•¢ã€‚æ­¦å™¨æ•ˆèƒ½æå‡ 15%ï¼Œå»ºè­°ç¶­æŒç•¶å‰ç«åŠ›è¼¸å‡ºã€‚";
            else if (type === 'start') text = "ç³»çµ±åˆå§‹åŒ–å®Œæˆã€‚ç¥ä½ å¥½é‹ï¼ŒæŒ‡æ®å®˜ã€‚";

            content.innerText = text;
            setTimeout(() => brief.classList.remove('active'), 5000);
        }

        class Player {
            constructor() {
                const char = CHARACTERS[userData.selectedChar];
                this.x = 0; this.y = 0; this.r = 18;
                this.maxHp = 100 * char.hpMod;
                this.hp = this.maxHp;
                this.speed = 5 * char.spdMod;
                this.xp = 0; this.lv = 1; this.nextXp = 60;
                this.fireTimer = 0;
            }
            update(keys) {
                let spd = this.speed + (UPGRADES.speed.level * 0.7);
                if (keys['KeyW'] || keys['ArrowUp']) this.y -= spd;
                if (keys['KeyS'] || keys['ArrowDown']) this.y += spd;
                if (keys['KeyA'] || keys['ArrowLeft']) this.x -= spd;
                if (keys['KeyD'] || keys['ArrowRight']) this.x += spd;

                this.fireTimer++;
                let rate = Math.max(7, 22 - (UPGRADES.fireRate.level * 3));
                if (this.fireTimer >= rate) {
                    this.shoot();
                    this.fireTimer = 0;
                }
                if (frame % 60 === 0 && UPGRADES.regen.level > 0) {
                    this.hp = Math.min(this.maxHp, this.hp + UPGRADES.regen.level * 0.6);
                }
            }
            shoot() {
                let target = activeBoss || null;
                if (!target) {
                    let minDist = 1000;
                    enemies.forEach(e => {
                        let d = Math.hypot(e.x-this.x, e.y-this.y);
                        if (d < minDist) { minDist = d; target = e; }
                    });
                }
                const angle = target ? Math.atan2(target.y-this.y, target.x-this.x) : -Math.PI/2;
                const count = 1 + UPGRADES.bullets.level;
                const dmg = (30 * CHARACTERS[userData.selectedChar].dmgMod) + (UPGRADES.damage.level * 15);
                
                for(let i=0; i<count; i++) {
                    const offset = (i - (count-1)/2) * 0.15;
                    bullets.push(new Bullet(this.x, this.y, angle + offset, dmg, UPGRADES.damage.level));
                }
            }
            draw() {
                const pos = camera.toScreen(this.x, this.y);
                ctx.save();
                ctx.translate(pos.x, pos.y);
                // åº•éƒ¨å…‰ç’°
                ctx.fillStyle = CHARACTERS[userData.selectedChar].color + '22';
                ctx.beginPath(); ctx.arc(0,0,this.r*2.5,0,Math.PI*2); ctx.fill();
                // è§’è‰²ä¸»é«”
                ctx.fillStyle = CHARACTERS[userData.selectedChar].color;
                ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke();
                ctx.restore();
            }
        }

        class Bullet {
            constructor(x, y, a, d, lv) {
                this.x = x; this.y = y; this.vx = Math.cos(a)*16; this.vy = Math.sin(a)*16;
                this.dmg = d; this.lv = lv; this.life = 80;
                this.history = [];
            }
            update() {
                this.history.unshift({x:this.x, y:this.y});
                if(this.history.length > 5) this.history.pop();
                this.x += this.vx; this.y += this.vy; this.life--;
            }
            draw() {
                const pos = camera.toScreen(this.x, this.y);
                // é€²åŒ–æ•ˆæœï¼šæµå…‰æ‹–å°¾
                if (this.lv >= 2) {
                    ctx.beginPath();
                    ctx.strokeStyle = this.lv >= 4 ? '#f472b6' : '#60a5fa';
                    ctx.lineWidth = 4;
                    this.history.forEach((h, i) => {
                        const hpos = camera.toScreen(h.x, h.y);
                        if(i===0) ctx.moveTo(hpos.x, hpos.y); else ctx.lineTo(hpos.x, hpos.y);
                    });
                    ctx.stroke();
                }
                ctx.fillStyle = this.lv >= 4 ? '#fdf2f8' : '#fff';
                ctx.shadowBlur = this.lv * 5;
                ctx.shadowColor = '#3b82f6';
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 5 + this.lv, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor(x, y, c, isGlow=false) {
                this.x = x; this.y = y; this.c = c;
                this.vx = (Math.random()-0.5)*12; this.vy = (Math.random()-0.5)*12;
                this.life = 1.0; this.decay = Math.random()*0.03 + 0.02;
                this.r = Math.random()*4 + 1;
                this.isGlow = isGlow;
            }
            update() { this.x += this.vx; this.y += this.vy; this.vx *= 0.96; this.vy *= 0.96; this.life -= this.decay; }
            draw() {
                const pos = camera.toScreen(this.x, this.y);
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.c;
                if(this.isGlow) { ctx.shadowBlur = 10; ctx.shadowColor = this.c; }
                ctx.beginPath(); ctx.arc(pos.x, pos.y, this.r, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0; ctx.globalAlpha = 1;
            }
        }

        class Enemy {
            constructor(lv) {
                const angle = Math.random()*Math.PI*2;
                this.x = player.x + Math.cos(angle)*900;
                this.y = player.y + Math.sin(angle)*900;
                this.r = 16 + Math.random()*10;
                this.hp = 30 + lv*20;
                this.speed = 1.8 + Math.random();
                this.color = isNewYearMode ? '#ef4444' : '#475569';
            }
            update() {
                const a = Math.atan2(player.y-this.y, player.x-this.x);
                this.x += Math.cos(a)*this.speed;
                this.y += Math.sin(a)*this.speed;
            }
            draw() {
                const pos = camera.toScreen(this.x, this.y);
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(pos.x, pos.y, this.r, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 2; ctx.stroke();
            }
        }

        class Boss {
            constructor(lv) {
                this.x = player.x + 600; this.y = player.y;
                this.r = 90; this.maxHp = 3000 + lv*1500;
                this.hp = this.maxHp;
                this.attackTimer = 0;
            }
            update() {
                const a = Math.atan2(player.y-this.y, player.x-this.x);
                this.x += Math.cos(a)*1.5; this.y += Math.sin(a)*1.5;
                this.attackTimer++;
                if (this.attackTimer > 120) {
                    this.specialAttack();
                    this.attackTimer = 0;
                }
            }
            specialAttack() {
                // æ–°å¹´æ¨¡å¼ Boss ç‰¹æ•ˆï¼šæ“´æ•£æ³¢
                for(let i=0; i<360; i+=20) {
                    const rad = i * Math.PI / 180;
                    for(let j=0; j<5; j++) {
                        particles.push(new Particle(this.x + Math.cos(rad)*50, this.y + Math.sin(rad)*50, '#fbbf24', true));
                    }
                }
                camera.shake = 15;
            }
            draw() {
                const pos = camera.toScreen(this.x, this.y);
                const grad = ctx.createRadialGradient(pos.x, pos.y, 0, pos.x, pos.y, this.r);
                grad.addColorStop(0, '#ef4444'); grad.addColorStop(1, '#991b1b');
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(pos.x, pos.y, this.r, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#facc15'; ctx.lineWidth = 6; ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.font = 'black 50px Arial'; ctx.textAlign = 'center';
                ctx.fillText(isNewYearMode ? 'è¯' : 'BOSS', pos.x, pos.y+18);
            }
        }

        function createFancyExplosion(x, y, c, count=20) {
            for(let i=0; i<count; i++) particles.push(new Particle(x, y, c, true));
            camera.shake = 8;
        }

        function loop() {
            if (!gameActive || gamePaused) return;
            frame++;
            ctx.fillStyle = '#020617'; ctx.fillRect(0,0,canvas.width,canvas.height);
            camera.update(player.x, player.y);
            
            // èƒŒæ™¯æ ¼ç·š
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = 2;
            const size = 120;
            const startX = Math.floor(camera.x / size) * size;
            const startY = Math.floor(camera.y / size) * size;
            for(let x=startX; x<startX+canvas.width+size; x+=size) {
                const p1 = camera.toScreen(x, startY); const p2 = camera.toScreen(x, startY+canvas.height+size);
                ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }
            for(let y=startY; y<startY+canvas.height+size; y+=size) {
                const p1 = camera.toScreen(startX, y); const p2 = camera.toScreen(startX+canvas.width+size, y);
                ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }

            player.update(keys);
            player.draw();

            if (frame % Math.max(8, 35-player.lv*2) === 0 && !activeBoss) {
                enemies.push(new Enemy(player.lv));
            }

            // è™•ç†å­å½ˆ
            for(let i=bullets.length-1; i>=0; i--) {
                const b = bullets[i]; b.update(); b.draw();
                if (b.life <= 0) { bullets.splice(i, 1); continue; }
                
                if (activeBoss && Math.hypot(b.x-activeBoss.x, b.y-activeBoss.y) < activeBoss.r) {
                    activeBoss.hp -= b.dmg; bullets.splice(i, 1);
                    if (activeBoss.hp <= 0) killBoss();
                    continue;
                }

                for(let j=enemies.length-1; j>=0; j--) {
                    const e = enemies[j];
                    if (Math.hypot(b.x-e.x, b.y-e.y) < e.r) {
                        e.hp -= b.dmg; bullets.splice(i, 1);
                        if (e.hp <= 0) {
                            score += 150; sessionCoins += 15;
                            createFancyExplosion(e.x, e.y, e.color);
                            orbs.push({ x: e.x, y: e.y, v: 25 });
                            enemies.splice(j, 1);
                        }
                        break;
                    }
                }
            }

            // è™•ç†æ•µäºº
            for(let i=enemies.length-1; i>=0; i--) {
                const e = enemies[i]; e.update(); e.draw();
                if (Math.hypot(player.x-e.x, player.y-e.y) < player.r + e.r) {
                    player.hp -= 0.6;
                    document.body.classList.add('damage-flash');
                    setTimeout(() => document.body.classList.remove('damage-flash'), 100);
                }
            }

            // è™•ç† Boss
            if (activeBoss) {
                activeBoss.update(); activeBoss.draw();
                document.getElementById('bossHpBar').style.width = (activeBoss.hp/activeBoss.maxHp*100)+'%';
                if (Math.hypot(player.x-activeBoss.x, player.y-activeBoss.y) < player.r + activeBoss.r) player.hp -= 1.5;
            } else if (frame % 3600 === 0) {
                spawnBoss();
            }

            // è™•ç†ç¶“é©—çƒ
            for(let i=orbs.length-1; i>=0; i--) {
                const o = orbs[i];
                const d = Math.hypot(player.x-o.x, player.y-o.y);
                if (d < 200) {
                    const a = Math.atan2(player.y-o.y, player.x-o.x);
                    o.x += Math.cos(a)*12; o.y += Math.sin(a)*12;
                }
                const pos = camera.toScreen(o.x, o.y);
                ctx.fillStyle = '#facc15'; ctx.shadowBlur = 10; ctx.shadowColor = '#fbbf24';
                ctx.beginPath(); ctx.arc(pos.x, pos.y, 5, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
                if (d < player.r + 5) {
                    player.xp += o.v; orbs.splice(i, 1);
                    if (player.xp >= player.nextXp) levelUp();
                }
            }

            // ç²’å­ç³»çµ±
            for(let i=particles.length-1; i>=0; i--) {
                const p = particles[i]; p.update(); p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            }

            updateHUD();
            if (player.hp <= 0) endGame();
            requestAnimationFrame(loop);
        }

        function updateHUD() {
            document.getElementById('hpUI').innerText = `HP: ${Math.ceil(player.hp)} / ${player.maxHp}`;
            document.getElementById('hpInnerBar').style.width = (player.hp/player.maxHp*100)+'%';
            document.getElementById('scoreUI').innerText = score.toString().padStart(6, '0');
            document.getElementById('coinVal').innerText = sessionCoins;
            document.getElementById('xpBar').style.width = (player.xp/player.nextXp*100)+'%';
        }

        function spawnBoss() {
            document.getElementById('bossWarning').style.display = 'block';
            triggerAISuggestion('boss');
            setTimeout(() => {
                document.getElementById('bossWarning').style.display = 'none';
                activeBoss = new Boss(player.lv);
                document.getElementById('bossHpContainer').style.display = 'block';
            }, 3000);
        }

        function killBoss() {
            createFancyExplosion(activeBoss.x, activeBoss.y, '#f59e0b', 80);
            score += 10000; sessionCoins += 1000;
            activeBoss = null;
            document.getElementById('bossHpContainer').style.display = 'none';
        }

        function levelUp() {
            player.lv++; player.xp = 0; player.nextXp *= 1.4;
            gamePaused = true;
            triggerAISuggestion('level');
            showUpgradeOptions();
        }

        function showUpgradeOptions() {
            const menu = document.getElementById('upgradeMenu');
            const container = document.getElementById('upgradeOptions');
            menu.classList.remove('hidden');
            container.innerHTML = '';
            const options = Object.keys(UPGRADES).sort(() => 0.5 - Math.random()).slice(0, 3);
            options.forEach(key => {
                const up = UPGRADES[key];
                const card = document.createElement('div');
                card.className = "bg-slate-900/80 p-10 rounded-[2.5rem] border-2 border-slate-700 hover:border-blue-500 cursor-pointer w-72 text-center transition-all hover:scale-105 backdrop-blur-md";
                card.innerHTML = `<div class="text-6xl mb-6">${up.icon}</div><div class="text-3xl font-black text-white mb-2 italic">${up.name}</div><div class="text-slate-400 text-sm mb-6">${up.desc}</div><div class="text-blue-400 font-bold tracking-widest uppercase">Level ${up.level} â†’ ${up.level+1}</div>`;
                card.onclick = () => { UPGRADES[key].level++; menu.classList.add('hidden'); gamePaused = false; loop(); };
                container.appendChild(card);
            });
        }

        function startGame(newYear) {
            isNewYearMode = newYear;
            document.getElementById('startMenu').classList.add('hidden');
            player = new Player();
            gameActive = true; frame = 0; score = 0; sessionCoins = 0;
            enemies = []; bullets = []; orbs = []; particles = []; activeBoss = null;
            Object.values(UPGRADES).forEach(u => u.level = 0);
            triggerAISuggestion('start');
            loop();
        }

        function endGame() {
            gameActive = false;
            userData.coins += sessionCoins;
            if (score > userData.highScore) userData.highScore = score;
            saveData();
            document.getElementById('deathMenu').classList.remove('hidden');
            document.getElementById('finalScore').innerText = `SCORE: ${score}`;
            document.getElementById('earnedCoins').innerText = sessionCoins;
        }

        function returnToMenu() {
            document.getElementById('deathMenu').classList.add('hidden');
            document.getElementById('startMenu').classList.remove('hidden');
            updateMenuUI();
        }

        function saveData() { localStorage.setItem(SAVE_KEY, JSON.stringify(userData)); }
        function loadData() {
            const raw = localStorage.getItem(SAVE_KEY);
            if (raw) userData = JSON.parse(raw);
            updateMenuUI();
        }
        function updateMenuUI() {
            document.getElementById('menuHighScore').innerText = userData.highScore;
            document.getElementById('menuCoins').innerText = userData.coins;
        }

        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        loadData();
    </script>
</body>
</html>