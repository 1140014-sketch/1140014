<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¥µé™å€–å­˜è€…ï¼šæ–°å¹´è³€æ­²ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        canvas { background-color: #111827; display: block; border-radius: 0.5rem; cursor: crosshair; }
        .hud { position: absolute; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 20; }
        
        #xpBarContainer { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: #1e293b; z-index: 10; }
        #xpBar { width: 0%; height: 100%; background: #3b82f6; transition: width 0.2s; }
        
        .damage-flash { animation: flash 0.15s; }
        @keyframes flash { 0% { background: rgba(220, 38, 38, 0.5); } 100% { background: transparent; } }
        
        .boss-warning { 
            position: absolute; top: 40%; left: 0; width: 100%; text-align: center;
            font-size: 5rem; font-weight: 900; color: #ef4444; z-index: 100;
            pointer-events: none; text-transform: uppercase; letter-spacing: 0.5rem;
            animation: boss-alert 1s infinite alternate; display: none;
        }
        @keyframes boss-alert { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1.1); } }
        
        #bossHpContainer { 
            position: absolute; top: 60px; left: 20%; width: 60%; height: 12px; 
            background: #450a0a; border: 2px solid #ef4444; border-radius: 6px; 
            display: none; z-index: 20;
        }
        #bossHpBar { width: 100%; height: 100%; background: #ef4444; transition: width 0.1s; }
        
        .save-indicator { position: fixed; bottom: 1rem; right: 1rem; font-size: 0.75rem; color: #4ade80; opacity: 0; transition: opacity 0.5s; z-index: 100; }
        .modal { backdrop-filter: blur(8px); }
        .scroll-custom::-webkit-scrollbar { width: 6px; }
        .scroll-custom::-webkit-scrollbar-track { background: transparent; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        #btnExitGame, #btnAIAnalysis { pointer-events: auto; cursor: pointer; }
        .interactive { pointer-events: auto; }
        
        .char-card { transition: all 0.2s; border: 2px solid transparent; }
        .char-card:hover { transform: translateY(-5px); border-color: #3b82f6; }
        .char-card.selected { border-color: #fbbf24; background: rgba(59, 130, 246, 0.2); }
        .char-card.locked { opacity: 0.6; filter: grayscale(1); }

        /* AI Loading Animation */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        /* New Year Style */
        .new-year-glow { text-shadow: 0 0 10px #ef4444, 0 0 20px #fbbf24; }
    </style>
</head>
<body class="flex items-center justify-center h-screen m-0">

    <div id="xpBarContainer"><div id="xpBar"></div></div>
    <div id="bossHpContainer"><div id="bossHpBar"></div></div>
    <div id="bossWarning" class="boss-warning">BOSS WARNING</div>
    <div id="saveIndicator" class="save-indicator">é€²åº¦å·²ä¿å­˜...</div>

    <div class="relative w-full h-full">
        <canvas id="gameCanvas"></canvas>
        <div class="hud top-4 left-4 text-green-400 font-bold text-xl" id="hpUI">HP: 100 / 100</div>
        
        <div class="hud top-16 right-4 text-right">
            <div id="scoreUI" class="text-white font-bold text-lg">SCORE: 0</div>
            <div id="coinUI" class="text-yellow-400 font-bold text-lg flex items-center justify-end gap-1">
                <span>$</span> <span id="coinVal">0</span>
            </div>
        </div>
        
        <button id="btnExitGame" onclick="confirmExit()" class="absolute top-4 right-4 bg-red-900/80 hover:bg-red-600 text-white px-4 py-2 rounded-lg border border-red-500/50 transition-colors text-xs font-bold z-50 shadow-lg interactive">
            é€€å‡ºæˆ°é¬¥ âœ•
        </button>

        <!-- AI æˆ°è¡“åˆ†ææŒ‰éˆ• -->
        <button id="btnAIAnalysis" onclick="openAIAnalysis()" class="absolute top-20 left-4 bg-cyan-900/80 hover:bg-cyan-600 text-cyan-100 px-4 py-2 rounded-lg border border-cyan-500/50 transition-colors text-xs font-bold z-50 shadow-lg interactive flex items-center gap-2">
            <span>ğŸ¤–</span> æˆ°è¡“åˆ†æ
        </button>

        <div class="hud top-12 left-1/2 -translate-x-1/2 text-center">
            <div id="levelUI" class="text-slate-500 text-xs uppercase">LEVEL 1</div>
        </div>
    </div>

    <!-- åˆå§‹ä¸»é¸å–® -->
    <div id="startMenu" class="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-50 p-4 modal overflow-y-auto">
        <div class="flex flex-col items-center max-w-4xl w-full">
            <h1 class="text-6xl font-black mb-4 text-blue-500 text-center uppercase tracking-tighter italic">Survivor<br><span class="text-3xl text-yellow-500 not-italic font-sans">Gacha Ops</span></h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full mb-8">
                <!-- ç‹€æ…‹æ¬„ -->
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
                    <p class="text-slate-500 text-xs uppercase font-bold tracking-widest text-center mb-4">æŒ‡æ®å®˜æª”æ¡ˆ</p>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">æŒæœ‰é‡‘å¹£</span>
                        <span class="text-yellow-400 font-black text-2xl" id="menuCoins">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-400">æœ€é«˜å¾—åˆ†</span>
                        <span class="text-white font-bold text-xl" id="menuHighScore">0</span>
                    </div>
                </div>

                <!-- æŠ½å¡/å•†åº—å…¥å£ -->
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl flex flex-col justify-center gap-3">
                    <button id="btnShop" class="w-full bg-yellow-600 hover:bg-yellow-500 py-3 rounded-xl font-bold text-white transition-all">ğŸ›’ è»éœ€åº« (è§’è‰²/æŠ½å¡)</button>
                    <button id="btnLog" class="w-full bg-slate-700 hover:bg-slate-600 py-2 rounded-xl text-sm font-bold text-white transition-all">ğŸ“‹ æ›´æ–°æ—¥èªŒ</button>
                </div>
            </div>

            <div class="flex flex-col w-full max-w-md gap-3">
                <button id="btnStart" class="w-full bg-blue-600 hover:bg-blue-500 px-12 py-5 rounded-2xl text-3xl font-bold transition-all transform hover:scale-105 shadow-lg shadow-blue-500/30 text-white">é–‹å§‹è¡Œå‹• (Endless)</button>
                
                <!-- æ–°å¹´ç‰¹åˆ¥æ´»å‹•æŒ‰éˆ• -->
                <button id="btnNewYear" class="hidden w-full bg-red-600 hover:bg-red-500 px-12 py-5 rounded-2xl text-2xl font-bold transition-all transform hover:scale-105 shadow-lg shadow-red-500/30 text-white border-2 border-yellow-400 new-year-glow">
                    ğŸ§¨ æ–°å¹´æŒ‘æˆ°ï¼šè¯ä»”ä¾†è¥²
                </button>

                <div id="characterSelectInfo" class="text-center text-blue-300 text-sm font-bold mt-2">ç•¶å‰ä½¿ç”¨ï¼šæ¨™æº–ç‰¹ç¨®å…µ</div>
            </div>
        </div>
    </div>

    <!-- è»éœ€åº« (å•†åº—/æŠ½å¡) -->
    <div id="shopModal" class="hidden absolute inset-0 bg-slate-950/95 flex flex-col items-center justify-center z-[60] p-4 modal">
        <div class="w-full max-w-5xl h-[90vh] bg-slate-900 rounded-3xl border border-slate-700 flex flex-col overflow-hidden shadow-2xl relative">
            <button id="btnCloseShop" class="absolute top-4 right-4 text-slate-400 hover:text-white text-2xl z-10">âœ•</button>
            <div class="flex border-b border-slate-700">
                <button class="flex-1 py-4 text-center font-bold bg-slate-800 text-blue-400" id="tabChars">äººå“¡èª¿åº¦ (Characters)</button>
                <button class="flex-1 py-4 text-center font-bold bg-slate-900 text-slate-500 hover:text-white" id="tabGacha">è£œçµ¦æŠ½ç (Gacha)</button>
            </div>
            <!-- è§’è‰²é é¢ -->
            <div id="panelChars" class="flex-1 p-8 overflow-y-auto scroll-custom">
                <h2 class="text-2xl font-bold text-white mb-6">é¸æ“‡ä½ çš„æˆ°é¬¥äººå“¡</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="charList"></div>
            </div>
            <!-- æŠ½å¡é é¢ -->
            <div id="panelGacha" class="hidden flex-1 p-8 flex flex-col items-center justify-center relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')] opacity-20"></div>
                <h2 class="text-3xl font-black text-yellow-400 mb-2">å¹¸é‹è£œçµ¦ç®±</h2>
                <p class="text-slate-400 mb-8">æŠ½å–æ°¸ä¹…å±¬æ€§åŠ æˆ (æ‰€æœ‰è§’è‰²é€šç”¨)</p>
                <div class="w-64 h-64 bg-slate-800 rounded-3xl border-4 border-yellow-500 flex items-center justify-center mb-8 shadow-[0_0_50px_rgba(234,179,8,0.2)]">
                    <span class="text-6xl">ğŸ“¦</span>
                </div>
                <div id="gachaResult" class="h-16 text-center mb-4">
                    <p class="text-2xl font-bold text-white animate-bounce hidden" id="gachaText">æ”»æ“ŠåŠ› +1 !</p>
                </div>
                <button id="btnDraw" class="bg-yellow-600 hover:bg-yellow-500 text-white px-12 py-4 rounded-full text-xl font-bold transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    æŠ½å–ä¸€æ¬¡ ($1000)
                </button>
                <div class="mt-8 text-left w-full max-w-md bg-slate-800/50 p-4 rounded-xl">
                    <p class="text-xs text-slate-500 font-bold mb-2">ç•¶å‰æ°¸ä¹…åŠ æˆï¼š</p>
                    <div id="statsList" class="grid grid-cols-2 gap-2 text-sm text-slate-300"></div>
                </div>
            </div>
            <div class="p-4 bg-slate-800 border-t border-slate-700 flex justify-between items-center">
                <span class="text-yellow-400 font-bold text-xl ml-4">æŒæœ‰é‡‘å¹£: $<span id="shopCoins">0</span></span>
            </div>
        </div>
    </div>

    <!-- AI è¨Šæ¯å½ˆçª— -->
    <div id="aiModal" class="hidden absolute inset-0 bg-slate-950/80 flex items-center justify-center z-[110] p-4 modal">
        <div class="bg-slate-800 p-8 rounded-3xl border border-cyan-500/50 w-full max-w-lg shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <svg class="w-32 h-32 text-cyan-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
            </div>
            <h3 class="text-2xl font-black mb-4 text-cyan-400 flex items-center gap-2">
                <span id="aiModalIcon">ğŸ¤–</span> <span id="aiModalTitle">AI æˆ°è¡“åˆ†æ</span>
            </h3>
            <div id="aiContent" class="text-slate-300 text-base leading-relaxed min-h-[80px]">
                <div class="flex items-center gap-2 text-cyan-500">
                    <div class="typing-dot w-2 h-2 bg-cyan-500 rounded-full"></div>
                    <div class="typing-dot w-2 h-2 bg-cyan-500 rounded-full"></div>
                    <div class="typing-dot w-2 h-2 bg-cyan-500 rounded-full"></div>
                    <span>é€£ç·šè‡³æˆ°è¡“ä¸»æ©Ÿ...</span>
                </div>
            </div>
            <button id="btnCloseAI" class="mt-6 w-full bg-cyan-700 hover:bg-cyan-600 text-white py-3 rounded-xl font-bold transition-colors">æ”¶åˆ°ï¼ŒåŸ·è¡ŒæŒ‡ä»¤</button>
        </div>
    </div>

    <!-- é€€å‡ºç¢ºèªè¦–çª— -->
    <div id="exitModal" class="hidden absolute inset-0 bg-slate-950/80 flex items-center justify-center z-[100] p-4 modal">
        <div class="bg-slate-800 p-8 rounded-3xl border border-red-500/50 w-full max-w-sm shadow-2xl text-center relative">
            <h3 class="text-2xl font-black mb-4 text-white">ç¢ºèªæ’¤é€€ï¼Ÿ</h3>
            <p class="text-slate-400 mb-8 text-sm">æˆ°é¬¥å°‡æœƒæš«åœã€‚è‹¥ç¢ºèªé€€å‡ºï¼Œç•¶å‰é€²åº¦å°‡æœƒéºå¤±ï¼Œåƒ…ä¿å­˜é‡‘å¹£èˆ‡æœ€é«˜åˆ†ã€‚</p>
            <div class="flex gap-4 justify-center">
                <button id="btnExitCancel" class="bg-slate-700 hover:bg-slate-600 text-white px-6 py-3 rounded-xl font-bold transition-colors w-1/2">å–æ¶ˆ</button>
                <button id="btnExitConfirm" class="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-xl font-bold transition-colors w-1/2">ç¢ºèªé€€å‡º</button>
            </div>
        </div>
    </div>

    <!-- æ›´æ–°æ—¥èªŒå½ˆçª— -->
    <div id="logModal" class="hidden absolute inset-0 bg-slate-950/90 flex items-center justify-center z-[60] p-6 modal">
        <div class="bg-slate-800 w-full max-w-lg rounded-3xl border border-slate-700 p-8 shadow-2xl flex flex-col max-h-[80vh]">
            <h2 class="text-2xl font-bold text-blue-400 mb-6 flex items-center gap-2"><span>ğŸ“‹</span> æ›´æ–°æ—¥èªŒ</h2>
            <div class="overflow-y-auto scroll-custom flex-1 space-y-6 pr-2">
                <div class="border-l-4 border-red-600 pl-4">
                    <h3 class="font-bold text-white">v2.2.3 - çˆ†ç‚¸ç‰¹æ•ˆ</h3>
                    <p class="text-sm text-slate-400">â— ğŸ§¨ æ–°å¢è¯éº—çš„ç²’å­çˆ†ç‚¸ç³»çµ±ã€‚</p>
                </div>
                 <div class="border-l-4 border-red-600 pl-4">
                    <h3 class="font-bold text-white">v2.2.2 - é­ç‚®å¤§éšŠ</h3>
                    <p class="text-sm text-slate-400">â— æ–°å¹´æ¨¡å¼é™å®šï¼šå°æ€ªè®Šç‚ºã€Œè‡ªçˆ†é­ç‚®ã€ã€‚</p>
                </div>
            </div>
            <button id="btnCloseLog" class="mt-8 w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-xl font-bold transition-all">è¿”å›é¸å–®</button>
        </div>
    </div>

    <!-- å‡ç´šä»‹é¢ -->
    <div id="upgradeMenu" class="hidden absolute inset-0 bg-slate-950/90 flex flex-col items-center justify-center z-40 modal">
        <h2 class="text-4xl font-black mb-8 text-blue-400 text-center px-4">åŸºå› é‡çµ„ï¼é¸æ“‡é€²åŒ–æ–¹å‘</h2>
        <div id="upgradeOptions" class="flex flex-wrap justify-center gap-6"></div>
    </div>

    <!-- çµæŸä»‹é¢ -->
    <div id="deathMenu" class="hidden absolute inset-0 bg-red-950/90 flex flex-col items-center justify-center z-50 modal">
        <h1 id="deathTitle" class="text-7xl font-black mb-4 text-white uppercase italic">å­˜æ´»çµ‚æ­¢</h1>
        <p id="finalScore" class="text-3xl mb-2 text-red-200 font-mono">SCORE: 0</p>
        <p class="text-yellow-400 text-xl mb-4 font-bold">+ $<span id="earnedCoins">0</span></p>
        <p id="unlockMsg" class="text-green-400 text-lg mb-8 font-bold animate-bounce hidden">ğŸ‰ å·²è§£é–é™å®šè§’è‰²ï¼šåŠ‰å¾·è¯ï¼</p>
        <div class="flex gap-4">
            <button id="btnMenuFromDeath" class="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-full text-xl font-bold transition-transform">è¿”å›é¸å–®</button>
            <button onclick="location.reload()" class="bg-white text-red-900 px-12 py-3 rounded-full text-xl font-bold shadow-xl hover:bg-slate-200 transition-transform hover:scale-105">é‡å•Ÿæˆ°å ´</button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const SAVE_KEY = 'survivor_game_v2_data';
        
        // BGM Setup
        const newYearBgm = new Audio('åŠ‰å¾·è¯Andy Lau-æ­å–œç™¼è²¡(Gong Xi Fa Cai).ogg');
        newYearBgm.loop = true;
        newYearBgm.volume = 0.4;

        let userData = { 
            highScore: 0, 
            coins: 0,
            inventory: ['soldier'], 
            selectedChar: 'soldier',
            gachaStats: { damage: 0, hp: 0, speed: 0, pickup: 0 }
        };

        const CHARACTERS = {
            soldier: { name: "æ¨™æº–ç‰¹ç¨®å…µ", desc: "å¹³è¡¡å‹ï¼Œé©åˆæ–°æ‰‹ã€‚", cost: 0, color: '#3b82f6', hpMod: 1, spdMod: 1, dmgMod: 1 },
            tank: { name: "é‡è£æ©Ÿå…µ", desc: "è¡€é‡æ¥µé«˜ï¼Œè‡ªå¸¶ç·©æ…¢å›è¡€ã€‚", cost: 2000, color: '#10b981', hpMod: 1.5, spdMod: 0.8, dmgMod: 0.9, regen: 0.2 },
            ghost: { name: "å¹½éˆç‰¹å·¥", desc: "æ¥µé€Ÿç§»å‹•ï¼Œé«˜çˆ†æ“Šç‡ã€‚", cost: 3500, color: '#8b5cf6', hpMod: 0.7, spdMod: 1.3, dmgMod: 1.2, crit: 0.2 },
            andylau: { name: "åŠ‰å¾·è¯", desc: "æ–°å¹´é™å®šï¼æ­å–œç™¼è²¡ï¼Œç´…åŒ…æ‹¿ä¾†ã€‚", cost: 99999, color: '#ef4444', hpMod: 1.2, spdMod: 1.1, dmgMod: 1.5, crit: 0.5, isHidden: true }
        };

        // --- Gemini API Helpers ---
        async function callGemini(prompt) {
            if (!apiKey) {
                console.warn("API Key is missing.");
                return "é€šè¨Šæ¨¡çµ„é›¢ç·š (API Key missing)";
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "è¨Šè™Ÿå¹²æ“¾ï¼Œç„¡æ³•è§£ææŒ‡ä»¤ã€‚";
            } catch (error) { console.error("Gemini Error:", error); return "é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"; }
        }

        // --- AI Features ---
        async function openAIAnalysis() {
            gamePaused = true;
            const modal = document.getElementById('aiModal');
            const content = document.getElementById('aiContent');
            const title = document.getElementById('aiModalTitle');
            const icon = document.getElementById('aiModalIcon');
            modal.classList.remove('hidden');
            title.textContent = "AI æˆ°è¡“åˆ†æ";
            icon.textContent = "ğŸ¤–";
            content.innerHTML = `<div class="flex items-center gap-2 text-cyan-500"><div class="typing-dot w-2 h-2 bg-cyan-500 rounded-full"></div><div class="typing-dot w-2 h-2 bg-cyan-500 rounded-full"></div><div class="typing-dot w-2 h-2 bg-cyan-500 rounded-full"></div><span>é€£ç·šè‡³æˆ°è¡“ä¸»æ©Ÿ...</span></div>`;
            const charName = CHARACTERS[userData.selectedChar].name;
            const context = `Role: Sci-fi tactical advisor AI. Status: Char:${charName}, HP:${Math.floor(player.hp)}, Score:${score}, Enemies:${enemies.length}. Task: Short tactical advice in Traditional Chinese.`;
            const reply = await callGemini(context);
            content.textContent = reply;
        }

        async function generateCharLore(charKey) {
            const btn = document.getElementById(`loreBtn-${charKey}`);
            if(btn) { btn.disabled = true; btn.textContent = "ç”Ÿæˆä¸­..."; }
            const char = CHARACTERS[charKey];
            const prompt = `Task: Generate sci-fi backstory for "${char.name}" in Traditional Chinese. Max 50 words.`;
            const lore = await callGemini(prompt);
            const modal = document.getElementById('aiModal');
            const content = document.getElementById('aiContent');
            const title = document.getElementById('aiModalTitle');
            const icon = document.getElementById('aiModalIcon');
            modal.classList.remove('hidden');
            title.textContent = `æ©Ÿå¯†æª”æ¡ˆï¼š${char.name}`;
            icon.textContent = "ğŸ“";
            content.textContent = lore;
            if(btn) { btn.disabled = false; btn.textContent = "âœ¨ ç”Ÿæˆæ©Ÿå¯†æª”æ¡ˆ"; }
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
            if (document.getElementById('startMenu').classList.contains('hidden') && !document.getElementById('deathMenu').classList.contains('hidden') === false) { gamePaused = false; }
        }

        function loadGameData() {
            const saved = localStorage.getItem(SAVE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    userData = { ...userData, ...parsed, gachaStats: { ...userData.gachaStats, ...parsed.gachaStats } };
                } catch(e) { console.error("Save file corrupted"); }
            }
            updateMenuUI();
        }

        function saveGame() {
            localStorage.setItem(SAVE_KEY, JSON.stringify(userData));
            updateMenuUI();
        }

        function updateMenuUI() {
            const menuHighScoreEl = document.getElementById('menuHighScore');
            if(menuHighScoreEl) menuHighScoreEl.textContent = userData.highScore;
            const menuCoinsEl = document.getElementById('menuCoins');
            if(menuCoinsEl) menuCoinsEl.textContent = userData.coins;
            const shopCoinsEl = document.getElementById('shopCoins');
            if(shopCoinsEl) shopCoinsEl.textContent = userData.coins;
            if (CHARACTERS[userData.selectedChar]) {
                const charName = CHARACTERS[userData.selectedChar].name;
                const charSelectInfo = document.getElementById('characterSelectInfo');
                if(charSelectInfo) charSelectInfo.textContent = `ç•¶å‰ä½¿ç”¨ï¼š${charName}`;
            }
            updateStatsDisplay();
            renderCharList();
        }

        function updateStatsDisplay() {
            const list = document.getElementById('statsList');
            const stats = userData.gachaStats;
            if (list) {
                list.innerHTML = `<div>âš”ï¸ å‚·å®³: +${stats.damage}</div><div>â¤ï¸ è¡€é‡: +${stats.hp}</div><div>ğŸ‘Ÿ é€Ÿåº¦: +${stats.speed.toFixed(1)}</div><div>ğŸ§² æ‹¾å–: +${stats.pickup}</div>`;
            }
        }

        // --- å…¨åŸŸè®Šæ•¸ ---
        const gameConfig = { width: window.innerWidth, height: window.innerHeight };
        let player, frame = 0, score = 0, shootTimer = 0, activeBoss = null;
        let enemies = [], bullets = [], orbs = [], bossBullets = [], medkits = [], coins = [], particles = [];
        let plasmaAngle = 0; 
        
        let gameActive = false;
        let gamePaused = false;
        let sessionCoins = 0; 
        let isNewYearMode = false;

        window.confirmExit = () => {
            gamePaused = true;
            document.getElementById('exitModal').classList.remove('hidden');
        };
        
        window.openAIAnalysis = openAIAnalysis;
        window.generateCharLore = generateCharLore;

        window.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const endDate = new Date('2026-02-02');
            if (now < endDate) { document.getElementById('btnNewYear').classList.remove('hidden'); }

            document.getElementById('btnExitCancel').onclick = () => { gamePaused = false; document.getElementById('exitModal').classList.add('hidden'); };
            document.getElementById('btnExitConfirm').onclick = () => { gamePaused = false; document.getElementById('exitModal').classList.add('hidden'); endGame(true); };
            document.getElementById('btnMenuFromDeath').onclick = returnToMenu;
            document.getElementById('btnLog').onclick = () => document.getElementById('logModal').classList.remove('hidden');
            document.getElementById('btnCloseLog').onclick = () => document.getElementById('logModal').classList.add('hidden');
            document.getElementById('btnShop').onclick = openShop;
            document.getElementById('btnCloseShop').onclick = closeShop;
            document.getElementById('tabChars').onclick = () => switchTab('chars');
            document.getElementById('tabGacha').onclick = () => switchTab('gacha');
            document.getElementById('btnDraw').onclick = drawGacha;
            document.getElementById('btnCloseAI').onclick = closeAIModal;

            const btnStart = document.getElementById('btnStart');
            if (btnStart) btnStart.onclick = () => { startGame(false); };
            const btnNewYear = document.getElementById('btnNewYear');
            if (btnNewYear) btnNewYear.onclick = () => { startGame(true); };

            loadGameData();
        });
        
        function startGame(isNewYear) {
            isNewYearMode = isNewYear;
            score = 0; sessionCoins = 0; 
            // Reset shootTimer
            shootTimer = 0;
            
            Object.values(UPGRADES).forEach(u => u.level = 0); 
            const coinVal = document.getElementById('coinVal');
            if(coinVal) coinVal.textContent = "0";

            if (audio.state === 'suspended') audio.resume();
            document.getElementById('startMenu').classList.add('hidden');
            
            if (isNewYearMode) {
                newYearBgm.currentTime = 0;
                newYearBgm.play().catch(e => console.error("BGM failed", e));
            }
            
            player = new Player(); 
            gameActive = true; 
            frame = 0;
            enemies = []; bullets = []; orbs = []; bossBullets = []; medkits = []; coins = []; activeBoss = null;
            particles = []; 
            gamePaused = false;
            loop();
        }

        function openShop() { document.getElementById('shopModal').classList.remove('hidden'); switchTab('chars'); }
        function closeShop() { document.getElementById('shopModal').classList.add('hidden'); }

        function switchTab(tab) {
            const btnChars = document.getElementById('tabChars');
            const btnGacha = document.getElementById('tabGacha');
            const panelChars = document.getElementById('panelChars');
            const panelGacha = document.getElementById('panelGacha');

            if (tab === 'chars') {
                btnChars.className = "flex-1 py-4 text-center font-bold bg-slate-800 text-blue-400";
                btnGacha.className = "flex-1 py-4 text-center font-bold bg-slate-900 text-slate-500 hover:text-white";
                panelChars.classList.remove('hidden'); panelGacha.classList.add('hidden'); renderCharList();
            } else {
                btnChars.className = "flex-1 py-4 text-center font-bold bg-slate-900 text-slate-500 hover:text-white";
                btnGacha.className = "flex-1 py-4 text-center font-bold bg-slate-800 text-yellow-400";
                panelChars.classList.add('hidden'); panelGacha.classList.remove('hidden'); updateGachaButton();
            }
        }

        function renderCharList() {
            const container = document.getElementById('charList');
            if(!container) return;
            container.innerHTML = '';
            Object.keys(CHARACTERS).forEach(key => {
                const char = CHARACTERS[key];
                if (char.isHidden && !userData.inventory.includes(key)) return; 
                const isOwned = userData.inventory.includes(key);
                const isSelected = userData.selectedChar === key;
                const div = document.createElement('div');
                div.className = `bg-slate-800 p-6 rounded-2xl flex flex-col gap-3 relative char-card ${isSelected ? 'selected' : ''}`;
                if (!isOwned) div.classList.add('locked');
                let actionBtn = '';
                if (isSelected) actionBtn = `<button class="w-full bg-slate-600 text-white py-2 rounded-lg font-bold cursor-default" disabled>å·²è£å‚™</button>`;
                else if (isOwned) actionBtn = `<button onclick="equipChar('${key}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold">è£å‚™</button>`;
                else {
                    const canAfford = userData.coins >= char.cost;
                    actionBtn = `<button onclick="buyChar('${key}')" class="w-full ${canAfford ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-slate-600 cursor-not-allowed'} text-white py-2 rounded-lg font-bold" ${!canAfford?'disabled':''}>è³¼è²· $${char.cost}</button>`;
                }
                const loreBtn = `<button id="loreBtn-${key}" onclick="generateCharLore('${key}')" class="mt-2 text-xs text-cyan-400 hover:text-cyan-300 underline self-start">âœ¨ ç”Ÿæˆæ©Ÿå¯†æª”æ¡ˆ</button>`;
                div.innerHTML = `<div class="absolute top-4 right-4 w-4 h-4 rounded-full" style="background:${char.color}"></div><h3 class="text-xl font-bold text-white">${char.name}</h3><p class="text-xs text-slate-400 flex-1">${char.desc}</p>${loreBtn}<div class="text-xs text-slate-300 space-y-1 my-2"><div class="flex justify-between"><span>HP</span><span class="font-mono">${Math.round(char.hpMod*100)}%</span></div><div class="flex justify-between"><span>SPD</span><span class="font-mono">${Math.round(char.spdMod*100)}%</span></div><div class="flex justify-between"><span>DMG</span><span class="font-mono">${Math.round(char.dmgMod*100)}%</span></div></div>${actionBtn}`;
                container.appendChild(div);
            });
        }

        window.equipChar = (key) => { userData.selectedChar = key; saveGame(); renderCharList(); };
        window.buyChar = (key) => {
            const cost = CHARACTERS[key].cost;
            if (userData.coins >= cost) { userData.coins -= cost; userData.inventory.push(key); userData.selectedChar = key; saveGame(); renderCharList(); playSfx(600, 'sine', 0.2); }
        };

        function updateGachaButton() {
            const btn = document.getElementById('btnDraw'); const canAfford = userData.coins >= 1000;
            btn.disabled = !canAfford;
            if (!canAfford) { btn.classList.add('bg-slate-600', 'cursor-not-allowed'); btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500'); }
            else { btn.classList.remove('bg-slate-600', 'cursor-not-allowed'); btn.classList.add('bg-yellow-600', 'hover:bg-yellow-500'); }
        }

        function drawGacha() {
            if (userData.coins < 1000) return;
            userData.coins -= 1000;
            const types = ['damage', 'hp', 'speed', 'pickup'];
            const type = types[Math.floor(Math.random() * types.length)];
            let val = 0; let text = "";
            if (type === 'damage') { val = 1; text = "æ”»æ“ŠåŠ› +1"; userData.gachaStats.damage += 1; }
            else if (type === 'hp') { val = 10; text = "æœ€å¤§è¡€é‡ +10"; userData.gachaStats.hp += 10; }
            else if (type === 'speed') { val = 0.2; text = "ç§»å‹•é€Ÿåº¦ +0.2"; userData.gachaStats.speed += 0.2; }
            else if (type === 'pickup') { val = 10; text = "æ‹¾å–ç¯„åœ +10"; userData.gachaStats.pickup += 10; }
            const resText = document.getElementById('gachaText'); resText.textContent = text; resText.classList.remove('hidden');
            setTimeout(() => resText.classList.add('hidden'), 2000);
            playSfx(800, 'square', 0.1); setTimeout(() => playSfx(1200, 'square', 0.2), 100);
            saveGame(); updateGachaButton(); updateStatsDisplay();
        }

        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, t, d, v=0.03) {
            try {
                if (audio.state === 'suspended') audio.resume();
                const o = audio.createOscillator(); const g = audio.createGain();
                o.type = t; o.frequency.setValueAtTime(f, audio.currentTime);
                g.gain.setValueAtTime(v, audio.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime+d);
                o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime+d);
            } catch(e) {}
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const camera = {
            x: 0, y: 0, zoom: 1, targetZoom: 1,
            update: function(tx, ty) {
                this.targetZoom = Math.max(0.4, 1 - (player.lv - 1) * 0.04);
                this.zoom += (this.targetZoom - this.zoom) * 0.05;
                this.x = tx - (gameConfig.width / 2) / this.zoom; 
                this.y = ty - (gameConfig.height / 2) / this.zoom;
            },
            toScreen: function(wx, wy) { return { x: (wx - this.x) * this.zoom, y: (wy - this.y) * this.zoom }; }
        };

        const UPGRADES = {
            bullets: { name: "æ¥µé™å½ˆé“", desc: "é¡å¤–å°„æ“Šè·¯ç·š", icon: "ğŸš€", level: 0 },
            fireRate: { name: "è¶…é »é€£ç™¼", desc: "å°„é€Ÿæå‡", icon: "ğŸ”¥", level: 0 },
            damage: { name: "æ¯€æ»…å½ˆé ­", desc: "å‚·å®³åŠ æˆ", icon: "ğŸ’£", level: 0 },
            speed: { name: "é–ƒé›»ç§»å‹•", desc: "ç§»å‹•åŠ é€Ÿ", icon: "ğŸƒ", level: 0 },
            magnet: { name: "å…¨åœ–æ‹¾å–", desc: "ç£åŠ›æ“´å¼µ", icon: "ğŸª", level: 0 },
            regen: { name: "å¥ˆç±³ä¿®å¾©", desc: "æ¯ç§’æ¢å¾©ç”Ÿå‘½", icon: "â¤ï¸", level: 0 }, 
            crit: { name: "å¼±é»åµæ¸¬", desc: "å¢åŠ çˆ†æ“Šæ©Ÿç‡", icon: "ğŸ¯", level: 0 }, 
            plasma: { name: "é›»æ¼¿åŠ›å ´", desc: "å‘¨åœæŒçºŒå‚·å®³", icon: "âš¡", level: 0 } 
        };

        function initCanvas() { gameConfig.width = canvas.width = window.innerWidth; gameConfig.height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', initCanvas); initCanvas();

        const keys = {};
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        class Player {
            constructor() {
                const baseChar = CHARACTERS[userData.selectedChar];
                const gacha = userData.gachaStats;

                this.x = 0; this.y = 0; this.r = 15;
                
                this.maxHp = (100 + gacha.hp) * baseChar.hpMod;
                this.hp = this.maxHp;
                this.xp = 0; this.lv = 1; this.nextXp = 50; 
                
                this.speed = (4.5 + gacha.speed) * baseChar.spdMod;
                this.pickupR = (100 + gacha.pickup); 
                this.baseDmg = (25 + gacha.damage) * baseChar.dmgMod;
                
                this.fireRate = 20; 
                this.bulletCount = 1;
                this.regenRate = baseChar.regen || 0;
                this.critChance = baseChar.crit || 0;
                this.plasmaDmg = 0;
                this.plasmaRange = 0;
            }
            update() {
                let currentSpeed = this.speed + (UPGRADES.speed.level * 0.5);
                
                if (keys['KeyW'] || keys['ArrowUp']) this.y -= currentSpeed;
                if (keys['KeyS'] || keys['ArrowDown']) this.y += currentSpeed;
                if (keys['KeyA'] || keys['ArrowLeft']) this.x -= currentSpeed;
                if (keys['KeyD'] || keys['ArrowRight']) this.x += currentSpeed;
                
                let currentFireRate = Math.max(5, this.fireRate - (UPGRADES.fireRate.level * 3));
                shootTimer++; if (shootTimer >= currentFireRate) { this.shoot(); shootTimer = 0; }
                
                let currentRegen = this.regenRate + (UPGRADES.regen.level * 0.5);
                if (frame % 60 === 0 && currentRegen > 0) {
                    this.hp = Math.min(this.maxHp, this.hp + currentRegen);
                }
            }
            shoot() {
                let target = activeBoss || null;
                if (!target) {
                    let minDist = 1000;
                    enemies.forEach(e => { const d = Math.hypot(e.x - this.x, e.y - this.y); if (d < minDist) { minDist = d; target = e; } });
                }
                const angle = target ? Math.atan2(target.y - this.y, target.x - this.x) : -Math.PI/2;
                
                let currentBulletCount = this.bulletCount + UPGRADES.bullets.level;
                let currentDmg = this.baseDmg + (UPGRADES.damage.level * 15);
                let currentCrit = this.critChance + (UPGRADES.crit.level * 0.1);

                for (let i = 0; i < currentBulletCount; i++) {
                    const offset = (i - (currentBulletCount - 1) / 2) * 0.3;
                    let isCrit = Math.random() < currentCrit;
                    let finalDmg = currentDmg * (isCrit ? 2 : 1);
                    bullets.push(new Bullet(this.x, this.y, angle + offset, finalDmg, isCrit));
                }
                playSfx(400, 'square', 0.05, 0.02);
            }
            draw() {
                const pos = camera.toScreen(this.x, this.y);
                ctx.save(); ctx.translate(pos.x, pos.y); ctx.scale(camera.zoom, camera.zoom);
                
                let pRange = this.plasmaRange;
                if(UPGRADES.plasma.level > 0) pRange = 150 + UPGRADES.plasma.level * 20;
                
                if (pRange > 0) {
                    ctx.beginPath(); ctx.arc(0, 0, pRange, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(100, 200, 255, 0.1)`; ctx.fill();
                    ctx.strokeStyle = `rgba(100, 200, 255, 0.3)`; ctx.lineWidth = 2; ctx.stroke();
                    ctx.save(); ctx.rotate(plasmaAngle);
                    for(let i=0; i<3; i++) {
                        ctx.rotate(Math.PI*2/3);
                        ctx.beginPath(); ctx.arc(pRange, 0, 5, 0, Math.PI*2); ctx.fillStyle = '#60a5fa'; ctx.fill();
                    }
                    ctx.restore();
                }

                ctx.beginPath(); ctx.arc(0, 0, this.r, 0, Math.PI*2);
                ctx.fillStyle = CHARACTERS[userData.selectedChar].color; 
                ctx.fill(); ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                ctx.restore();
            }
        }

        class Bullet {
            constructor(x, y, a, d, isCrit) { 
                this.x = x; this.y = y; this.dmg = d; this.vx = Math.cos(a)*12; this.vy = Math.sin(a)*12; 
                this.r = isCrit ? 6 : 3.5; 
                this.color = isCrit ? '#fca5a5' : '#60a5fa'; 
                this.life = 120;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life--; }
            draw() { 
                const pos = camera.toScreen(this.x, this.y); 
                ctx.beginPath(); ctx.arc(pos.x, pos.y, this.r * camera.zoom, 0, Math.PI*2); 
                ctx.fillStyle = this.color; ctx.fill(); 
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.decay = Math.random() * 0.03 + 0.02;
                this.color = color;
                this.size = Math.random() * 4 + 2;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vx *= 0.95; this.vy *= 0.95;
                this.life -= this.decay;
            }
            draw() {
                if (this.life <= 0) return;
                const pos = camera.toScreen(this.x, this.y);
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, this.size * camera.zoom, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function createExplosion(x, y, color, count = 15) {
            for(let i=0; i<count; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        class Enemy {
            constructor(x, y, type='slime') {
                this.type = type;
                if (x === undefined || y === undefined) {
                    const angle = Math.random() * Math.PI * 2;
                    this.x = player.x + Math.cos(angle) * (850 / camera.zoom);
                    this.y = player.y + Math.sin(angle) * (850 / camera.zoom);
                } else {
                    this.x = x; this.y = y;
                }
                
                this.r = 12 + Math.random() * 8; 
                this.hp = (20 + player.lv * 15);
                this.speed = (1.2 + Math.random());
                this.wobbleOffset = Math.random() * 10;
                
                if (this.type === 'firecracker') {
                    this.speed *= 1.4; // Faster
                    this.color = '#ef4444';
                    this.hp *= 0.8; // Squishier
                }
            }
            
            update() { 
                if (this.type === 'firecracker') {
                    const dist = Math.hypot(player.x - this.x, player.y - this.y);
                    if (dist < 100) { // Explosion range
                        this.explode();
                        return;
                    }
                }
                
                const angle = Math.atan2(player.y - this.y, player.x - this.x); 
                this.x += Math.cos(angle) * this.speed; 
                this.y += Math.sin(angle) * this.speed; 
            }

            explode() {
                // Damage player
                player.hp -= 20; 
                document.body.classList.add('damage-flash');
                setTimeout(() => document.body.classList.remove('damage-flash'), 50);
                
                // Visuals
                createExplosion(this.x, this.y, '#fbbf24', 20);
                playSfx(100, 'sawtooth', 0.2, 0.2); // Explosion sound
                
                // Die
                this.hp = 0; 
            }

            draw() { 
                const pos = camera.toScreen(this.x, this.y); 
                const r = this.r * camera.zoom;
                
                ctx.save(); ctx.translate(pos.x, pos.y);
                
                if (this.type === 'firecracker') {
                    // Firecracker visual
                    const angle = Math.atan2(player.y - this.y, player.x - this.x);
                    ctx.rotate(angle);
                    ctx.fillStyle = '#b91c1c'; // Dark red body
                    ctx.fillRect(-r, -r/2, r*2, r);
                    // Fuse
                    ctx.fillStyle = '#fbbf24';
                    ctx.fillRect(r, -2, 10, 4);
                    // Spark
                    if (Math.random() > 0.5) {
                        ctx.fillStyle = '#fcd34d';
                        ctx.beginPath(); ctx.arc(r+10, 0, 3, 0, Math.PI*2); ctx.fill();
                    }
                } else {
                    // Slime visual
                    const wobble = Math.sin(frame * 0.2 + this.wobbleOffset) * (r * 0.15); 
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.moveTo(-r, 0); 
                    ctx.bezierCurveTo(-r, -r*1.5 + wobble, r, -r*1.5 + wobble, r, 0);
                    ctx.quadraticCurveTo(r + wobble, r*0.8, 0, r*0.8);
                    ctx.quadraticCurveTo(-r - wobble, r*0.8, -r, 0);
                    ctx.fill();
                    // Eyes
                    ctx.fillStyle = 'white';
                    ctx.beginPath(); ctx.arc(-r*0.3, -r*0.2 + wobble*0.5, r*0.25, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(r*0.3, -r*0.2 + wobble*0.5, r*0.25, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = 'black';
                    ctx.beginPath(); ctx.arc(-r*0.3, -r*0.2 + wobble*0.5, r*0.1, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(r*0.3, -r*0.2 + wobble*0.5, r*0.1, 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            }
        }

        class Medkit {
            constructor(x, y) { this.x = x; this.y = y; this.r = 12; this.heal = 30; }
            update() { 
                let pR = player.pickupR + (UPGRADES.magnet.level * 60);
                const d = Math.hypot(player.x - this.x, player.y - this.y); 
                if (d < pR) { const a = Math.atan2(player.y - this.y, player.x - this.x); this.x += Math.cos(a)*8; this.y += Math.sin(a)*8; } 
            }
            draw() { const pos = camera.toScreen(this.x, this.y); ctx.save(); ctx.translate(pos.x, pos.y); ctx.scale(camera.zoom, camera.zoom); ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.roundRect(-10, -10, 20, 20, 4); ctx.fill(); ctx.fillStyle = 'white'; ctx.fillRect(-2, -7, 4, 14); ctx.fillRect(-7, -2, 14, 4); ctx.restore(); }
        }
        
        class Coin {
            constructor(x, y, v=1) { this.x = x; this.y = y; this.r = 6; this.val = v; }
            update() {
                let pR = player.pickupR + (UPGRADES.magnet.level * 60);
                const d = Math.hypot(player.x - this.x, player.y - this.y);
                if (d < pR) { const a = Math.atan2(player.y - this.y, player.x - this.x); this.x += Math.cos(a)*14; this.y += Math.sin(a)*14; }
            }
            draw() {
                const pos = camera.toScreen(this.x, this.y);
                ctx.save(); ctx.translate(pos.x, pos.y); ctx.scale(camera.zoom, camera.zoom);
                ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.arc(0,0, this.r, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#b45309'; ctx.font = 'bold 8px Arial'; ctx.textAlign = 'center'; ctx.textBaseline='middle'; ctx.fillText('$', 0, 1);
                ctx.restore();
            }
        }

        class Boss {
            constructor(lv, type='normal') {
                this.x = player.x + 600; this.y = player.y; 
                this.r = 80; 
                this.type = type;
                if (type === 'andy') { this.maxHp = 5000 + lv * 1000; this.name = "Andy Lau"; } else { this.maxHp = 1000 + lv * 600; this.name = "Slime King"; }
                this.hp = this.maxHp; this.speed = 0.9; this.timer = 0;
            }
            update() { 
                const a = Math.atan2(player.y - this.y, player.x - this.x); 
                this.x += Math.cos(a) * this.speed; this.y += Math.sin(a) * this.speed; 
                this.timer++; 
                if (this.timer > 100) { if(this.type === 'andy') this.andyAttack(); else this.attack(); this.timer = 0; } 
            }
            attack() { for (let i=0; i<20; i++) bossBullets.push(new BossBullet(this.x, this.y, (Math.PI*2/20)*i)); }
            andyAttack() {
                for(let i=0; i<10; i++) { bossBullets.push(new BossBullet(this.x, this.y, Math.random()*Math.PI*2, 'firecracker')); }
                bossBullets.push(new BossBullet(this.x, this.y, Math.atan2(player.y - this.y, player.x - this.x), 'couplet'));
            }
            draw() { 
                const pos = camera.toScreen(this.x, this.y); const r = this.r * camera.zoom;
                ctx.save(); ctx.translate(pos.x, pos.y);
                if (this.type === 'andy') {
                    ctx.fillStyle = '#b91c1c'; ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = '#fcd34d'; ctx.lineWidth = 5; ctx.stroke();
                    ctx.fillStyle = 'white'; ctx.font = `bold ${r*0.6}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText("è¯", 0, 0);
                } else {
                    const wobble = Math.sin(frame * 0.1) * (r * 0.1); 
                    const grad = ctx.createRadialGradient(0, -r*0.5, r*0.2, 0, 0, r);
                    grad.addColorStop(0, '#f87171'); grad.addColorStop(1, '#7f1d1d');
                    ctx.fillStyle = grad;
                    ctx.beginPath(); ctx.moveTo(-r, 0); 
                    ctx.bezierCurveTo(-r, -r*1.6 + wobble, r, -r*1.6 + wobble, r, 0);
                    ctx.quadraticCurveTo(r + wobble*0.5, r*0.9, 0, r*0.9);
                    ctx.quadraticCurveTo(-r - wobble*0.5, r*0.9, -r, 0);
                    ctx.fill(); ctx.lineWidth = 4; ctx.strokeStyle = '#fff'; ctx.stroke();
                    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.ellipse(-r*0.3, -r*0.3 + wobble*0.5, r*0.2, r*0.3, -0.2, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.ellipse(r*0.3, -r*0.3 + wobble*0.5, r*0.2, r*0.3, 0.2, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = 'red'; 
                    ctx.beginPath(); ctx.arc(-r*0.3, -r*0.3 + wobble*0.5, r*0.05, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(r*0.3, -r*0.3 + wobble*0.5, r*0.05, 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            }
        }

        class BossBullet {
            constructor(x, y, a, type='normal') { 
                this.x = x; this.y = y; this.type = type; this.r = 8; let speed = 5;
                if (type === 'firecracker') { speed = 8; this.r = 5; }
                if (type === 'couplet') { speed = 3; this.r = 20; }
                this.vx = Math.cos(a)*speed; this.vy = Math.sin(a)*speed; this.angle = a;
            }
            update() { this.x += this.vx; this.y += this.vy; }
            draw() { 
                const pos = camera.toScreen(this.x, this.y); const r = this.r * camera.zoom;
                if (this.type === 'couplet') {
                     ctx.save(); ctx.translate(pos.x, pos.y); ctx.rotate(this.angle);
                     ctx.fillStyle = '#ef4444'; ctx.fillRect(-r, -r/2, r*3, r);
                     ctx.fillStyle = '#fcd34d'; ctx.font = `${r*0.8}px Arial`; ctx.fillText("ç¦", -r*0.5, r*0.3); ctx.restore();
                } else if (this.type === 'firecracker') {
                    ctx.beginPath(); ctx.arc(pos.x, pos.y, r, 0, Math.PI*2); ctx.fillStyle = '#ef4444'; ctx.fill();
                    if(Math.random() > 0.5) { ctx.fillStyle = 'yellow'; ctx.fillRect(pos.x, pos.y, 2, 2); }
                } else {
                    ctx.beginPath(); ctx.arc(pos.x, pos.y, r, 0, Math.PI*2); ctx.fillStyle = '#f87171'; ctx.fill(); 
                }
            }
        }

        class Orb {
            constructor(x, y, v=10) { this.x = x; this.y = y; this.r = 4; this.val = v; }
            update() { 
                let pR = player.pickupR + (UPGRADES.magnet.level * 60);
                const d = Math.hypot(player.x - this.x, player.y - this.y); if (d < pR) { const a = Math.atan2(player.y - this.y, player.x - this.x); this.x += Math.cos(a)*10; this.y += Math.sin(a)*10; } 
            }
            draw() { const pos = camera.toScreen(this.x, this.y); ctx.beginPath(); ctx.arc(pos.x, pos.y, this.r * camera.zoom, 0, Math.PI*2); ctx.fillStyle = this.val > 50 ? '#8b5cf6' : '#fbbf24'; ctx.fill(); }
        }

        function loop() {
            if (!gameActive) return;
            if (gamePaused) { requestAnimationFrame(loop); return; }

            ctx.clearRect(0, 0, gameConfig.width, gameConfig.height); frame++; plasmaAngle += 0.05;
            camera.update(player.x, player.y);
            
            ctx.beginPath(); ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1;
            const gs = 100 * camera.zoom;
            for (let x = (-camera.x * camera.zoom) % gs; x < gameConfig.width; x += gs) { ctx.moveTo(x, 0); ctx.lineTo(x, gameConfig.height); }
            for (let y = (-camera.y * camera.zoom) % gs; y < gameConfig.height; y += gs) { ctx.moveTo(0, y); ctx.lineTo(gameConfig.width, y); }
            ctx.stroke();

            player.update(); player.draw();

            if (!activeBoss && frame % Math.max(5, 30 - player.lv) === 0) spawnEnemy();
            if (activeBoss) {
                activeBoss.update(); activeBoss.draw();
                document.getElementById('bossHpBar').style.width = (activeBoss.hp / activeBoss.maxHp * 100) + '%';
            }
            
            // Explosion Logic
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update();
                p.draw();
                if (p.life <= 0) particles.splice(i, 1);
            }

            // Collisions
            for (let i = bullets.length-1; i>=0; i--) {
                const b = bullets[i]; b.update(); b.draw();
                if (b.life <= 0) { bullets.splice(i,1); continue; }
                if (activeBoss && Math.hypot(b.x-activeBoss.x, b.y-activeBoss.y) < activeBoss.r+b.r) {
                    activeBoss.hp -= b.dmg; bullets.splice(i,1);
                    if (activeBoss.hp <= 0) { 
                        createExplosion(activeBoss.x, activeBoss.y, '#fcd34d', 50); // Boss explosion
                        score += 2000; sessionCoins += 500; 
                        coins.push(new Coin(activeBoss.x, activeBoss.y, 500));
                        for(let k=0; k<30; k++) orbs.push(new Orb(activeBoss.x + Math.random()*100-50, activeBoss.y + Math.random()*100-50, 100));
                        medkits.push(new Medkit(activeBoss.x, activeBoss.y)); 
                        if (activeBoss.type === 'andy') {
                            if (!userData.inventory.includes('andylau')) {
                                userData.inventory.push('andylau');
                                document.getElementById('unlockMsg').classList.remove('hidden');
                                setTimeout(() => document.getElementById('unlockMsg').classList.add('hidden'), 5000);
                            }
                        }
                        activeBoss = null; document.getElementById('bossHpContainer').style.display = 'none'; 
                    }
                    continue;
                }
                for (let j = enemies.length-1; j>=0; j--) {
                    const e = enemies[j];
                    if (Math.hypot(e.x-b.x, e.y-b.y) < e.r+b.r) {
                        e.hp -= b.dmg; bullets.splice(i,1);
                        if (e.hp <= 0) { 
                            if(e.type === 'firecracker') createExplosion(e.x, e.y, '#ef4444', 10);
                            score += 15; orbs.push(new Orb(e.x, e.y)); 
                            if (Math.random() < 0.05) medkits.push(new Medkit(e.x, e.y));
                            let coinVal = Math.floor(Math.random() * 51) + 50;
                            coins.push(new Coin(e.x, e.y, coinVal));
                            enemies.splice(j,1); 
                        }
                        break;
                    }
                }
            }

            for (let i = enemies.length-1; i>=0; i--) {
                const e = enemies[i]; e.update(); e.draw();
                let pRange = player.plasmaRange; if(UPGRADES.plasma.level > 0) pRange = 150 + UPGRADES.plasma.level * 20;
                if (player.plasmaDmg > 0 && Math.hypot(player.x - e.x, player.y - e.y) < pRange + e.r) {
                    e.hp -= player.plasmaDmg * 0.1; 
                    if (e.hp <= 0) { 
                        if(e.type === 'firecracker') createExplosion(e.x, e.y, '#ef4444', 10);
                        score += 15; orbs.push(new Orb(e.x, e.y)); 
                        let coinVal = Math.floor(Math.random() * 51) + 50;
                        coins.push(new Coin(e.x, e.y, coinVal));
                        enemies.splice(i,1); continue; 
                    }
                }
                if (Math.hypot(player.x-e.x, player.y-e.y) < player.r+e.r) {
                    player.hp -= 0.5; document.body.classList.add('damage-flash');
                    setTimeout(() => document.body.classList.remove('damage-flash'), 50);
                }
            }
            
            for (let i = bossBullets.length-1; i>=0; i--) {
                const bb = bossBullets[i]; bb.update(); bb.draw();
                if (Math.hypot(player.x - bb.x, player.y - bb.y) < player.r + bb.r) {
                    player.hp -= 15;
                    document.body.classList.add('damage-flash');
                    setTimeout(() => document.body.classList.remove('damage-flash'), 50);
                    bossBullets.splice(i, 1);
                }
            }

            for (let i = orbs.length-1; i>=0; i--) {
                const o = orbs[i]; o.update(); o.draw();
                if (Math.hypot(player.x-o.x, player.y-o.y) < player.r+o.r) {
                    player.xp += o.val; orbs.splice(i,1);
                    if (player.xp >= player.nextXp) { player.lv++; player.xp = 0; player.nextXp *= 1.35; showUpgrade(); }
                }
            }

            for (let i = medkits.length-1; i>=0; i--) {
                const m = medkits[i]; m.update(); m.draw();
                if (Math.hypot(player.x-m.x, player.y-m.y) < player.r+m.r) {
                    player.hp = Math.min(player.maxHp, player.hp + m.heal);
                    medkits.splice(i,1); playSfx(800, 'sine', 0.2, 0.05);
                }
            }
            
            for (let i = coins.length-1; i>=0; i--) {
                const c = coins[i]; c.update(); c.draw();
                if (Math.hypot(player.x-c.x, player.y-c.y) < player.r+c.r) {
                    sessionCoins += c.val; coins.splice(i,1); playSfx(1000, 'triangle', 0.1, 0.05);
                    document.getElementById('coinVal').textContent = sessionCoins;
                }
            }

            if (player.hp <= 0) { endGame(false); return; }

            document.getElementById('hpUI').textContent = `HP: ${Math.ceil(player.hp)} / ${player.maxHp}`;
            document.getElementById('scoreUI').textContent = `SCORE: ${score}`;
            document.getElementById('levelUI').textContent = `LEVEL ${player.lv}`;
            document.getElementById('xpBar').style.width = (player.xp / player.nextXp * 100) + '%';
            requestAnimationFrame(loop);
        }

        function spawnEnemy() {
             const angle = Math.random() * Math.PI * 2;
             const dist = Math.max(canvas.width, canvas.height) / 1.5 + 400; // Farther out
             // Adjust based on camera
             let x = player.x + Math.cos(angle) * (850 / camera.zoom);
             let y = player.y + Math.sin(angle) * (850 / camera.zoom);
             
             // In New Year Mode, spawn Firecrackers
             const type = isNewYearMode ? 'firecracker' : 'slime';
             enemies.push(new Enemy(x, y, type));
        }

        function returnToMenu() {
            gameActive = false;
            document.getElementById('deathMenu').classList.add('hidden');
            document.getElementById('bossWarning').style.display = 'none';
            document.getElementById('bossHpContainer').style.display = 'none';
            document.getElementById('startMenu').classList.remove('hidden');
            if (isNewYearMode) newYearBgm.pause(); 
            // Reset
            enemies = []; bullets = []; orbs = []; bossBullets = []; medkits = []; coins = []; explosions = []; particles = []; activeBoss = null;
            loadGameData();
        }

        function endGame(manualExit) {
            gameActive = false; 
            if (isNewYearMode) newYearBgm.pause();
            
            userData.coins += sessionCoins;
            if (score > userData.highScore) {
                userData.highScore = score;
            }
            saveGame();

            if (manualExit) {
                returnToMenu();
            } else {
                document.getElementById('deathMenu').classList.remove('hidden');
                document.getElementById('finalScore').textContent = `SCORE: ${score}`;
                document.getElementById('earnedCoins').textContent = sessionCoins;
                if (score >= userData.highScore && score > 0) {
                     document.getElementById('newRecordText').style.opacity = 1;
                }
            }
        }

        function showUpgrade() {
            gameActive = false; document.getElementById('upgradeMenu').classList.remove('hidden');
            const options = document.getElementById('upgradeOptions'); options.innerHTML = '';
            const picks = Object.keys(UPGRADES).sort(() => 0.5 - Math.random()).slice(0, 3);
            picks.forEach(key => {
                const up = UPGRADES[key]; const card = document.createElement('div');
                card.className = "bg-slate-800 p-6 rounded-xl border-2 border-slate-700 hover:border-blue-500 cursor-pointer w-48 text-center transition-all hover:scale-105 shadow-lg";
                card.innerHTML = `<div class="text-4xl mb-4">${up.icon}</div><div class="font-bold text-xl mb-2">${up.name}</div><div class="text-xs text-slate-400">${up.desc}</div><div class="mt-4 text-blue-400 font-mono">LV ${up.level}</div>`;
                card.onclick = () => { applyUpgrade(key); document.getElementById('upgradeMenu').classList.add('hidden'); gameActive = true; if (player.lv % 5 === 0 && !activeBoss) spawnBoss(); loop(); };
                options.appendChild(card);
            });
        }

        function applyUpgrade(key) {
            UPGRADES[key].level++;
            playSfx(600, 'sine', 0.2);
        }

        function spawnBoss() {
            document.getElementById('bossWarning').style.display = 'block';
            
            const bossType = isNewYearMode ? 'andy' : 'normal';
            
            if (bossType === 'andy') {
                 document.getElementById('bossWarning').style.color = '#fbbf24';
                 document.getElementById('bossWarning').innerText = "ANDY LAU ç™»å ´";
            } else {
                 document.getElementById('bossWarning').style.color = '#ef4444';
                 document.getElementById('bossWarning').innerText = "BOSS WARNING";
            }

            setTimeout(() => { 
                document.getElementById('bossWarning').style.display = 'none'; 
                activeBoss = new Boss(player.lv, bossType); 
                document.getElementById('bossHpContainer').style.display = 'block'; 
            }, 3000);
        }
    </script>
</body>
</html>